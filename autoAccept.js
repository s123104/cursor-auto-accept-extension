// Cursor Ëá™ÂãïÊé•ÂèóËÖ≥Êú¨ÔºåÂ∏∂ÊúâÊ™îÊ°àÂàÜÊûêÂíåÊäïË≥áÂõûÂ†±Áéá (ROI) ËøΩËπ§ÂäüËÉΩ
// ‰ΩúËÄÖÔºö@ivalsaraj (https://linkedin.com/in/ivalsaraj)
// GitHub: https://github.com/ivalsaraj/cursor-auto-accept-full-agentic-mode
(function () {
  'use strict';

  if (window.autoAcceptAndAnalytics) return; // ÈÅøÂÖçÈáçË§áËºâÂÖ•

  if (typeof globalThis.autoAcceptAndAnalytics === 'undefined') {
    class autoAcceptAndAnalytics {
      constructor(interval = 2000) {
        this.interval = interval;
        this.isRunning = false;
        this.monitorInterval = null;
        this.totalClicks = 0;
        this.controlPanel = null;
        this.isDragging = false;
        this.dragOffset = { x: 0, y: 0 };
        this.currentTab = 'main'; // 'main' (‰∏ªÈù¢Êùø), 'analytics' (ÂàÜÊûê), Êàñ 'roi' (ÊäïË≥áÂõûÂ†±Áéá)
        this.loggedMessages = new Set(); // ËøΩËπ§Â∑≤Ë®òÈåÑÁöÑË®äÊÅØ‰ª•Èò≤Ê≠¢ÈáçË§á
        this.debugMode = false; // ÊéßÂà∂Èô§ÈåØÊó•Ë™åÁöÑËº∏Âá∫

        // Ê™îÊ°àÂàÜÊûêËøΩËπ§
        this.analytics = {
          files: new Map(), // Ê™îÂêç -> { Êé•ÂèóÊ¨°Êï∏, ÊúÄÂæåÊé•ÂèóÊôÇÈñì, Â¢ûÂä†Ë°åÊï∏, Âà™Èô§Ë°åÊï∏ }
          sessions: [], // ËøΩËπ§ÊúÉË©±Ë≥áÊñô
          totalAccepts: 0,
          sessionStart: new Date(),
        };

        // ROI ÊôÇÈñìËøΩËπ§ - ÂÆåÊï¥Â∑•‰ΩúÊµÅÁ®ãÊ∏¨Èáè
        this.roiTracking = {
          totalTimeSaved: 0, // ÂñÆ‰ΩçÔºöÊØ´Áßí
          codeGenerationSessions: [],
          // ÂÆåÊï¥Â∑•‰ΩúÊµÅÁ®ãÊôÇÈñì (‰ΩøÁî®ËÄÖÊèêÁ§∫ ‚Üí Cursor ÂÆåÊàê)
          averageCompleteWorkflow: 30000, // 30 ÁßíÔºö‰ΩøÁî®ËÄÖËßÄÁúã Cursor ÁîüÊàê + ÊâãÂãïÊé•Âèó
          averageAutomatedWorkflow: 100, // Á¥Ñ 100 ÊØ´ÁßíÔºöËÖ≥Êú¨Âç≥ÊôÇÂÅµÊ∏¨‰∏¶ÈªûÊìä
          // ÊâãÂãïÂ∑•‰ΩúÊµÅÁ®ãÂàÜËß£Ôºö
          // - ‰ΩøÁî®ËÄÖÁôºÈÄÅÊèêÁ§∫Ôºö0Áßí (ÂÖ©ËÄÖÁõ∏Âêå)
          // - Cursor ÁîüÊàêÔºö10-20Áßí (ÂÖ©ËÄÖÁõ∏Âêå)
          // - ‰ΩøÁî®ËÄÖËßÄÁúãÁîüÊàêÈÅéÁ®ãÔºö5-15Áßí (Ë¢´ËÖ≥Êú¨Ê∂àÈô§)
          // - ‰ΩøÁî®ËÄÖÂ∞ãÊâæ‰∏¶ÈªûÊìäÊåâÈàïÔºö2-3Áßí (Ë¢´ËÖ≥Êú¨Ê∂àÈô§)
          // - ‰∏ä‰∏ãÊñáÂàáÊèõÔºö1-2Áßí (Ë¢´ËÖ≥Êú¨Ê∂àÈô§)
          currentWorkflowStart: null,
          currentSessionButtons: 0,
          workflowSessions: [], // ËøΩËπ§ÂñÆÂÄãÂ∑•‰ΩúÊµÅÁ®ãÁöÑÊôÇÈñì
        };

        // ÊåâÈàïÈ°ûÂûãÈÖçÁΩÆ
        this.config = {
          enableAcceptAll: true,
          enableAccept: true,
          enableRun: true,
          enableRunCommand: true,
          enableApply: true,
          enableExecute: true,
          enableResume: true,
        };

        // ËºâÂÖ•ÊåÅ‰πÖÂåñË≥áÊñô
        this.loadFromStorage();

        this.createControlPanel();
        this.log('autoAcceptAndAnalytics Â∑≤ÂàùÂßãÂåñÔºåÂåÖÂê´Ê™îÊ°àÂàÜÊûêËàá ROI ËøΩËπ§');
      }

      // ÊåÅ‰πÖÂåñÊñπÊ≥ï
      saveToStorage() {
        try {
          const data = {
            analytics: {
              files: Array.from(this.analytics.files.entries()),
              sessions: this.analytics.sessions,
              totalAccepts: this.analytics.totalAccepts,
              sessionStart: this.analytics.sessionStart,
            },
            roiTracking: this.roiTracking,
            config: this.config,
            totalClicks: this.totalClicks,
            savedAt: new Date(),
          };
          localStorage.setItem('cursor-auto-accept-data', JSON.stringify(data));
        } catch (error) {
          console.warn('ÂÑ≤Â≠òÂà∞ localStorage Â§±ÊïóÔºö', error);
        }
      }

      loadFromStorage() {
        try {
          const saved = localStorage.getItem('cursor-auto-accept-data');
          if (saved) {
            const data = JSON.parse(saved);

            // ÊÅ¢Âæ©ÂàÜÊûêË≥áÊñô
            if (data.analytics) {
              this.analytics.files = new Map(data.analytics.files || []);
              this.analytics.sessions = data.analytics.sessions || [];
              this.analytics.totalAccepts = data.analytics.totalAccepts || 0;
              this.analytics.sessionStart = data.analytics.sessionStart
                ? new Date(data.analytics.sessionStart)
                : new Date();
            }

            // ÊÅ¢Âæ© ROI ËøΩËπ§Ë≥áÊñô
            if (data.roiTracking) {
              this.roiTracking = { ...this.roiTracking, ...data.roiTracking };
            }

            // ÊÅ¢Âæ©Ë®≠ÂÆö
            if (data.config) {
              this.config = { ...this.config, ...data.config };
            }

            // ÊÅ¢Âæ©ÈªûÊìäÊ¨°Êï∏
            if (data.totalClicks) {
              this.totalClicks = data.totalClicks;
            }

            console.log('Â∑≤Âæû localStorage ËºâÂÖ•Ë≥áÊñô');
          }
        } catch (error) {
          console.warn('Âæû localStorage ËºâÂÖ•Â§±ÊïóÔºö', error);
        }
      }

      clearStorage() {
        try {
          localStorage.removeItem('cursor-auto-accept-data');
          console.log('ÂÑ≤Â≠òÁ©∫ÈñìÂ∑≤Ê∏ÖÈô§');

          // ÂêåÊôÇÈáçÁΩÆÁï∂ÂâçÊúÉË©±Ë≥áÊñô
          this.analytics.files.clear();
          this.analytics.sessions = [];
          this.analytics.totalAccepts = 0;
          this.analytics.sessionStart = new Date();
          this.roiTracking.totalTimeSaved = 0;
          this.totalClicks = 0;

          // Êõ¥Êñ∞ UI
          this.updateAnalyticsContent();
          this.updateMainFooter();
          this.updatePanelStatus();

          this.logToPanel('üóëÔ∏è ÊâÄÊúâË≥áÊñôÂ∑≤Ê∏ÖÈô§ (ÂÑ≤Â≠òÁ©∫Èñì + Áï∂ÂâçÊúÉË©±)', 'warning');
        } catch (error) {
          console.warn('Ê∏ÖÈô§ localStorage Â§±ÊïóÔºö', error);
        }
      }

      validateData() {
        console.log('=== Ë≥áÊñôÈ©óË≠â ===');
        console.log('ÊúÉË©±Ë≥áË®äÔºö');
        console.log(`  ÊúÉË©±ÈñãÂßãÊôÇÈñìÔºö${this.analytics.sessionStart}`);
        console.log(`  Á∏ΩÊé•ÂèóÊ¨°Êï∏Ôºö${this.analytics.totalAccepts}`);
        console.log(`  Á∏ΩÈªûÊìäÊ¨°Êï∏Ôºö${this.totalClicks}`);
        console.log(`  Á∏ΩÁØÄÁúÅÊôÇÈñìÔºö${this.formatTimeDuration(this.roiTracking.totalTimeSaved)}`);

        console.log('\nÂ∑≤ËøΩËπ§Ê™îÊ°àÔºö');
        this.analytics.files.forEach((data, filename) => {
          console.log(`  ${filename}:`);
          console.log(`    Êé•ÂèóÊ¨°Êï∏Ôºö${data.acceptCount}`);
          console.log(`    Á∏ΩÂ¢ûÂä†Ë°åÊï∏Ôºö+${data.totalAdded}`);
          console.log(`    Á∏ΩÂà™Èô§Ë°åÊï∏Ôºö-${data.totalDeleted}`);
          console.log(`    ÊúÄÂæåÊé•ÂèóÊôÇÈñìÔºö${data.lastAccepted}`);
        });

        console.log('\nÊúÄËøëÊúÉË©±Ôºö');
        this.analytics.sessions.slice(-5).forEach((session, i) => {
          console.log(
            `  ${i + 1}. ${session.filename} (+${session.addedLines}/-${
              session.deletedLines
            }) [${session.buttonType}] Êñº ${session.timestamp}`
          );
        });

        console.log('\nLocalStorage Ê™¢Êü•Ôºö');
        try {
          const saved = localStorage.getItem('cursor-auto-accept-data');
          if (saved) {
            const data = JSON.parse(saved);
            console.log('  ÂÑ≤Â≠òÁ©∫ÈñìÂ≠òÂú®ÔºåÂÑ≤Â≠òÊñºÔºö', data.savedAt);
            console.log('  ÂÑ≤Â≠òÁ©∫ÈñìÂàÜÊûêÁ∏ΩÊé•ÂèóÊ¨°Êï∏Ôºö', data.analytics?.totalAccepts || 0);
            console.log('  ÂÑ≤Â≠òÁ©∫ÈñìÁ∏ΩÈªûÊìäÊ¨°Êï∏Ôºö', data.totalClicks || 0);
          } else {
            console.log('  localStorage ‰∏≠Ê≤íÊúâË≥áÊñô');
          }
        } catch (error) {
          console.log('  ËÆÄÂèñ localStorage ÊôÇÂá∫ÈåØÔºö', error);
        }

        console.log('=== È©óË≠âÁµêÊùü ===');
        return {
          currentSession: {
            totalAccepts: this.analytics.totalAccepts,
            totalClicks: this.totalClicks,
            timeSaved: this.roiTracking.totalTimeSaved,
            filesCount: this.analytics.files.size,
          },
          isDataConsistent: this.analytics.totalAccepts === this.analytics.sessions.length,
        };
      }

      toggleDebug() {
        this.debugMode = !this.debugMode;
        console.log(`Èô§ÈåØÊ®°Âºè ${this.debugMode ? 'Â∑≤ÂïüÁî®' : 'Â∑≤ÂÅúÁî®'}`);
        this.logToPanel(`Èô§ÈåØÊ®°Âºè ${this.debugMode ? 'ÈñãÂïü' : 'ÈóúÈñâ'}`, 'info');
        return this.debugMode;
      }

      calibrateWorkflowTimes(manualWorkflowSeconds, automatedWorkflowMs = 100) {
        const oldManual = this.roiTracking.averageCompleteWorkflow;
        const oldAuto = this.roiTracking.averageAutomatedWorkflow;

        this.roiTracking.averageCompleteWorkflow = manualWorkflowSeconds * 1000;
        this.roiTracking.averageAutomatedWorkflow = automatedWorkflowMs;

        console.log(`Â∑•‰ΩúÊµÅÁ®ãÊôÇÈñìÂ∑≤Êõ¥Êñ∞Ôºö`);
        console.log(`  ÊâãÂãïÔºö${oldManual / 1000}Áßí ‚Üí ${manualWorkflowSeconds}Áßí`);
        console.log(`  Ëá™ÂãïÔºö${oldAuto}ÊØ´Áßí ‚Üí ${automatedWorkflowMs}ÊØ´Áßí`);

        // ÈáçÊñ∞Ë®àÁÆóÊâÄÊúâÁèæÊúâÁöÑÂ∑•‰ΩúÊµÅÁ®ãÊúÉË©±
        this.roiTracking.totalTimeSaved = 0;
        this.roiTracking.workflowSessions.forEach(session => {
          const timeSaved =
            this.roiTracking.averageCompleteWorkflow - this.roiTracking.averageAutomatedWorkflow;
          this.roiTracking.totalTimeSaved += timeSaved;
          session.timeSaved = timeSaved;
        });

        this.saveToStorage();
        this.updateAnalyticsContent();
        this.updateMainFooter();

        this.logToPanel(`Â∑•‰ΩúÊµÅÁ®ãÂ∑≤Ê†°Ê∫ñÔºö${manualWorkflowSeconds}ÁßíÊâãÂãï`, 'info');
        return {
          manual: manualWorkflowSeconds,
          automated: automatedWorkflowMs,
        };
      }

      // ROI ËøΩËπ§ÊñπÊ≥ï
      startCodeGenSession() {
        this.roiTracking.currentSessionStart = new Date();
        this.roiTracking.currentSessionButtons = 0;
      }

      endCodeGenSession() {
        if (this.roiTracking.currentSessionStart) {
          const sessionDuration = new Date() - this.roiTracking.currentSessionStart;
          this.roiTracking.codeGenerationSessions.push({
            start: this.roiTracking.currentSessionStart,
            duration: sessionDuration,
            buttonsClicked: this.roiTracking.currentSessionButtons,
            timeSaved: this.roiTracking.currentSessionButtons * this.roiTracking.manualClickTime,
          });
          this.roiTracking.currentSessionStart = null;
        }
      }

      calculateTimeSaved(buttonType) {
        // Âü∫ÊñºÂÆåÊï¥Â∑•‰ΩúÊµÅÁ®ãËá™ÂãïÂåñË®àÁÆóÁØÄÁúÅÁöÑÊôÇÈñì
        // ÊâãÂãïÂ∑•‰ΩúÊµÅÁ®ãÔºö‰ΩøÁî®ËÄÖËßÄÁúãÁîüÊàê + Â∞ãÊâæÊåâÈàï + ÈªûÊìä + ‰∏ä‰∏ãÊñáÂàáÊèõ
        // Ëá™ÂãïÂ∑•‰ΩúÊµÅÁ®ãÔºöËÖ≥Êú¨Âú®‰ΩøÁî®ËÄÖÂ∞àÊ≥®ÊñºÁ∑®Á¢ºÊôÇÁ´ãÂç≥ÂÅµÊ∏¨‰∏¶ÈªûÊìä

        const workflowTimeSavings = {
          'accept all': this.roiTracking.averageCompleteWorkflow + 5000, // ÂØ©Êü•ÊâÄÊúâËÆäÊõ¥ÁöÑÈ°çÂ§ñÊôÇÈñì
          accept: this.roiTracking.averageCompleteWorkflow,
          run: this.roiTracking.averageCompleteWorkflow + 2000, // Âü∑Ë°åÂëΩ‰ª§ÊôÇÈúÄË¶ÅÈ°çÂ§ñË¨πÊÖé
          execute: this.roiTracking.averageCompleteWorkflow + 2000,
          apply: this.roiTracking.averageCompleteWorkflow,
          resume: this.roiTracking.averageCompleteWorkflow + 3000, // Ëá™ÂãïÁπºÁ∫åÂ∞çË©±ÊâÄÁØÄÁúÅÁöÑÊôÇÈñì
        };

        const manualTime =
          workflowTimeSavings[buttonType.toLowerCase()] || this.roiTracking.averageCompleteWorkflow;
        const automatedTime = this.roiTracking.averageAutomatedWorkflow;
        const timeSaved = manualTime - automatedTime;

        this.roiTracking.totalTimeSaved += timeSaved;
        this.roiTracking.currentSessionButtons++;

        // ËøΩËπ§Ê≠§Â∑•‰ΩúÊµÅÁ®ãÊúÉË©±
        this.roiTracking.workflowSessions.push({
          timestamp: new Date(),
          buttonType: buttonType,
          manualTime: manualTime,
          automatedTime: automatedTime,
          timeSaved: timeSaved,
        });

        // ÊØèÊ¨°Êõ¥Êñ∞ÂæåÂÑ≤Â≠òÂà∞ÂÑ≤Â≠òÁ©∫Èñì
        this.saveToStorage();

        return timeSaved;
      }

      formatTimeDuration(milliseconds) {
        if (!milliseconds || isNaN(milliseconds) || milliseconds <= 0) return '0Áßí';

        const totalSeconds = Math.floor(milliseconds / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;

        if (hours > 0) {
          return `${hours}Â∞èÊôÇ ${minutes}ÂàÜ ${seconds}Áßí`;
        } else if (minutes > 0) {
          return `${minutes}ÂàÜ ${seconds}Áßí`;
        } else {
          return `${seconds}Áßí`;
        }
      }

      // Âú®ÈªûÊìäÊåâÈàïÊôÇÂæûÁ®ãÂºèÁ¢ºÂçÄÂ°ä‰∏≠ÊèêÂèñÊ™îÊ°àË≥áË®ä
      extractFileInfo(button) {
        try {
          if (this.debugMode) {
            this.log('=== Èô§ÈåØÔºöÂëºÂè´ extractFileInfo ===');
            this.log(`ÊåâÈàïÊñáÂ≠óÔºö "${button.textContent.trim()}"`);
            this.log(`ÊåâÈàï classÔºö ${button.className}`);
          }

          // Êñ∞ÊñπÊ≥ïÔºöÂú® conversations div ‰∏≠Â∞ãÊâæÊúÄÊñ∞ÁöÑ diff ÂçÄÂ°ä
          const conversationsDiv = document.querySelector('div.conversations');
          if (!conversationsDiv) {
            if (this.debugMode) this.log('Èô§ÈåØÔºöÊú™ÊâæÂà∞ conversations div');
            return null;
          }

          // Â∞ãÊâæÊâÄÊúâÂ∏∂Êúâ data-message-index ÁöÑË®äÊÅØÊ∞£Ê≥°ÔºåÊåâÁ¥¢ÂºïÊéíÂ∫è (ÊúÄÊñ∞ÂÑ™ÂÖà)
          const messageBubbles = Array.from(
            conversationsDiv.querySelectorAll('[data-message-index]')
          ).sort((a, b) => {
            const indexA = parseInt(a.getAttribute('data-message-index'));
            const indexB = parseInt(b.getAttribute('data-message-index'));
            return indexB - indexA; // ÈôçÂ∫è (ÊúÄÊñ∞ÂÑ™ÂÖà)
          });

          if (this.debugMode) {
            this.log(`Èô§ÈåØÔºöÊâæÂà∞ ${messageBubbles.length} ÂÄãË®äÊÅØÊ∞£Ê≥°`);
            if (messageBubbles.length > 0) {
              const latestIndex = messageBubbles[0].getAttribute('data-message-index');
              this.log(`Èô§ÈåØÔºöÊúÄÊñ∞Ë®äÊÅØÁ¥¢ÂºïÔºö${latestIndex}`);
            }
          }

          // Âú®ÊúÄÊñ∞ÁöÑÂπæÊ¢ùË®äÊÅØ‰∏≠Â∞ãÊâæ diff ÂçÄÂ°ä
          for (let i = 0; i < Math.min(5, messageBubbles.length); i++) {
            const bubble = messageBubbles[i];
            const messageIndex = bubble.getAttribute('data-message-index');

            if (this.debugMode) {
              this.log(`Èô§ÈåØÔºöÊ≠£Âú®Ê™¢Êü•Ë®äÊÅØ ${messageIndex}`);
            }

            // Âú®Ê≠§Ë®äÊÅØ‰∏≠Â∞ãÊâæÁ®ãÂºèÁ¢ºÂçÄÂ°äÂÆπÂô®
            const codeBlocks = bubble.querySelectorAll(
              '.composer-code-block-container, .composer-tool-former-message, .composer-diff-block'
            );

            if (this.debugMode && codeBlocks.length > 0) {
              this.log(`Èô§ÈåØÔºöÂú®Ë®äÊÅØ ${messageIndex} ‰∏≠ÊâæÂà∞ ${codeBlocks.length} ÂÄãÁ®ãÂºèÁ¢ºÂçÄÂ°ä`);
            }

            for (const block of codeBlocks) {
              const fileInfo = this.extractFileInfoFromBlock(block);
              if (fileInfo) {
                if (this.debugMode) {
                  this.log(`Èô§ÈåØÔºöÊàêÂäüÊèêÂèñÊ™îÊ°àË≥áË®äÔºö${JSON.stringify(fileInfo)}`);
                }
                return fileInfo;
              }
            }
          }

          if (this.debugMode) {
            this.log('Èô§ÈåØÔºöÂú®ÊúÄËøëÁöÑË®äÊÅØ‰∏≠Êú™ÊâæÂà∞Ê™îÊ°àË≥áË®äÔºåÂòóË©¶ÂÇôÁî®ÊñπÊ≥ï');
          }

          // ÂÇôÁî®ÊñπÊ°àÔºöÂòóË©¶ËàäÊñπÊ≥ï‰ΩúÁÇ∫ÂæåÂÇô
          return this.extractFileInfoFallback(button);
        } catch (error) {
          this.log(`ÊèêÂèñÊ™îÊ°àË≥áË®äÊôÇÂá∫ÈåØÔºö${error.message}`);
          if (this.debugMode) {
            this.log(`Èô§ÈåØÔºöÈåØË™§Â†ÜÁñäÔºö${error.stack}`);
          }
          return null;
        }
      }

      // ÂæûÁâπÂÆöÁöÑÁ®ãÂºèÁ¢ºÂçÄÂ°ä‰∏≠ÊèêÂèñÊ™îÊ°àË≥áË®ä
      extractFileInfoFromBlock(block) {
        try {
          if (this.debugMode) {
            this.log(`Èô§ÈåØÔºöÊ≠£Âú®ÂàÜÊûê class ÁÇ∫ ${block.className} ÁöÑÂçÄÂ°ä`);
          }

          // Âú®Â§öÂÄãÂèØËÉΩÁöÑ‰ΩçÁΩÆÂ∞ãÊâæÊ™îÂêç
          let filename = null;
          let addedLines = 0;
          let deletedLines = 0;

          // ÊñπÊ≥ï 1Ôºö.composer-code-block-filename span
          const filenameSpan =
            block.querySelector('.composer-code-block-filename span[style*="direction: ltr"]') ||
            block.querySelector('.composer-code-block-filename span') ||
            block.querySelector('.composer-code-block-filename');

          if (filenameSpan) {
            filename = filenameSpan.textContent.trim();
            if (this.debugMode) {
              this.log(`Èô§ÈåØÔºöÈÄèÈÅé span ÊâæÂà∞Ê™îÂêçÔºö"${filename}"`);
            }
          }

          // ÊñπÊ≥ï 2ÔºöÂ∞ãÊâæ‰ªª‰ΩïÂÖßÂÆπÈ°û‰ººÊ™îÂêçÁöÑÂÖÉÁ¥†
          if (!filename) {
            const allSpans = block.querySelectorAll('span');
            for (const span of allSpans) {
              const text = span.textContent.trim();
              // Ê™¢Êü•ÊñáÂ≠óÊòØÂê¶ÂÉèÊ™îÂêç (ÊúâÂâØÊ™îÂêç)
              if (text && text.includes('.') && text.length < 100 && !text.includes(' ')) {
                const parts = text.split('.');
                if (parts.length >= 2 && parts[parts.length - 1].length <= 10) {
                  filename = text;
                  if (this.debugMode) {
                    this.log(`Èô§ÈåØÔºöÈÄèÈÅéÊ®°ÂºèÂåπÈÖçÊâæÂà∞Ê™îÂêçÔºö"${filename}"`);
                  }
                  break;
                }
              }
            }
          }

          // ÂæûÁãÄÊÖãÂÖÉÁ¥†‰∏≠ÊèêÂèñ diff Áµ±Ë®àË≥áË®ä
          const statusElements = block.querySelectorAll(
            '.composer-code-block-status span, span[style*="color"]'
          );

          if (this.debugMode) {
            this.log(`Èô§ÈåØÔºöÊâæÂà∞ ${statusElements.length} ÂÄãÁãÄÊÖãÂÖÉÁ¥†`);
          }

          for (const statusEl of statusElements) {
            const statusText = statusEl.textContent.trim();
            if (this.debugMode) {
              this.log(`Èô§ÈåØÔºöÁãÄÊÖãÊñáÂ≠óÔºö"${statusText}"`);
            }

            // Â∞ãÊâæ +N/-N Ê®°Âºè
            const addedMatch = statusText.match(/\+(\d+)/);
            const deletedMatch = statusText.match(/-(\d+)/);

            if (addedMatch) {
              addedLines = Math.max(addedLines, parseInt(addedMatch[1]));
              if (this.debugMode) {
                this.log(`Èô§ÈåØÔºöÊâæÂà∞Â¢ûÂä†ÁöÑË°åÊï∏Ôºö${addedLines}`);
              }
            }
            if (deletedMatch) {
              deletedLines = Math.max(deletedLines, parseInt(deletedMatch[1]));
              if (this.debugMode) {
                this.log(`Èô§ÈåØÔºöÊâæÂà∞Âà™Èô§ÁöÑË°åÊï∏Ôºö${deletedLines}`);
              }
            }
          }

          if (filename) {
            const fileInfo = {
              filename,
              addedLines: addedLines || 0,
              deletedLines: deletedLines || 0,
              timestamp: new Date(),
            };

            if (this.debugMode) {
              this.log(`Èô§ÈåØÔºöÂª∫Á´ãÁöÑÊ™îÊ°àË≥áË®äÁâ©‰ª∂Ôºö${JSON.stringify(fileInfo)}`);
            }

            return fileInfo;
          }

          if (this.debugMode) {
            this.log('Èô§ÈåØÔºöÊ≠§ÂçÄÂ°ä‰∏≠Êú™ÊâæÂà∞Ê™îÂêç');
          }
          return null;
        } catch (error) {
          if (this.debugMode) {
            this.log(`Èô§ÈåØÔºöextractFileInfoFromBlock Âá∫ÈåØÔºö${error.message}`);
          }
          return null;
        }
      }

      // ÂÇôÁî®ÊñπÊ≥ï (ÂéüÂßãÊñπÊ≥ï)
      extractFileInfoFallback(button) {
        try {
          if (this.debugMode) {
            this.log('Èô§ÈåØÔºö‰ΩøÁî®ÂÇôÁî®ÊèêÂèñÊñπÊ≥ï');
          }

          // Â∞ãÊâæÂåÖÂê´Ê≠§ÊåâÈàïÁöÑ composer-code-block-container
          let container = button.closest('.composer-code-block-container');
          if (!container) {
            // ÂòóË©¶Âú®Áà∂ÂÖÉÁ¥†‰∏≠Â∞ãÊâæ
            let parent = button.parentElement;
            let attempts = 0;
            while (parent && attempts < 10) {
              container = parent.querySelector('.composer-code-block-container');
              if (container) break;
              parent = parent.parentElement;
              attempts++;
            }
          }

          if (!container) {
            if (this.debugMode) {
              this.log('Èô§ÈåØÔºöÂú®ÂÇôÁî®ÊñπÊ≥ï‰∏≠Êú™ÊâæÂà∞ÂÆπÂô®');
            }
            return null;
          }

          // Âæû .composer-code-block-filename ÊèêÂèñÊ™îÂêç
          let filenameElement = container.querySelector(
            '.composer-code-block-filename span[style*="direction: ltr"]'
          );
          if (!filenameElement) {
            filenameElement = container.querySelector('.composer-code-block-filename span');
          }
          if (!filenameElement) {
            filenameElement = container.querySelector('.composer-code-block-filename');
          }
          const filename = filenameElement ? filenameElement.textContent.trim() : 'Êú™Áü•Ê™îÊ°à';

          // Âæû .composer-code-block-status ÊèêÂèñ diff Áµ±Ë®àË≥áË®ä
          const statusElement = container.querySelector('.composer-code-block-status span');
          let addedLines = 0;
          let deletedLines = 0;

          if (statusElement) {
            const statusText = statusElement.textContent;
            const addedMatch = statusText.match(/\+(\d+)/);
            const deletedMatch = statusText.match(/-(\d+)/);

            if (addedMatch) addedLines = parseInt(addedMatch[1]);
            if (deletedMatch) deletedLines = parseInt(deletedMatch[1]);

            if (this.debugMode) {
              this.log(
                `Èô§ÈåØÔºöÂÇôÁî®ÊñπÊ≥ïÊèêÂèñ - Ê™îÊ°àÔºö${filename}, ÁãÄÊÖãÔºö"${statusText}", +${addedLines}/-${deletedLines}`
              );
            }
          }

          return {
            filename,
            addedLines: addedLines || 0,
            deletedLines: deletedLines || 0,
            timestamp: new Date(),
          };
        } catch (error) {
          if (this.debugMode) {
            this.log(`Èô§ÈåØÔºöÂÇôÁî®ÊñπÊ≥ïÂá∫ÈåØÔºö${error.message}`);
          }
          return null;
        }
      }

      // ËøΩËπ§Ê™îÊ°àÊé•ÂèóÊÉÖÊ≥Å
      trackFileAcceptance(fileInfo, buttonType = 'accept') {
        if (!fileInfo || !fileInfo.filename) return;

        const { filename, addedLines, deletedLines, timestamp } = fileInfo;

        // Ê®ôÊ∫ñÂåñÊåâÈàïÈ°ûÂûã‰ª•ÈÄ≤Ë°å‰∏ÄËá¥ËøΩËπ§
        const normalizedButtonType = this.normalizeButtonType(buttonType);

        // Ë®àÁÆóÊ≠§Êìç‰ΩúÁØÄÁúÅÁöÑÊôÇÈñì
        const timeSaved = this.calculateTimeSaved(normalizedButtonType);

        // Á¢∫‰øùÊï∏Â≠óÊúâÊïà (‰∏çÊòØ NaN)
        const safeAddedLines = isNaN(addedLines) ? 0 : addedLines;
        const safeDeletedLines = isNaN(deletedLines) ? 0 : deletedLines;
        const safeTimeSaved = isNaN(timeSaved) ? 0 : timeSaved;

        // Êõ¥Êñ∞Ê™îÊ°àÁµ±Ë®à
        if (this.analytics.files.has(filename)) {
          const existing = this.analytics.files.get(filename);
          existing.acceptCount++;
          existing.lastAccepted = timestamp;
          existing.totalAdded += safeAddedLines;
          existing.totalDeleted += safeDeletedLines;

          // ËøΩËπ§ÊåâÈàïÈ°ûÂûãË®àÊï∏
          if (!existing.buttonTypes) {
            existing.buttonTypes = {};
          }
          existing.buttonTypes[normalizedButtonType] =
            (existing.buttonTypes[normalizedButtonType] || 0) + 1;
        } else {
          this.analytics.files.set(filename, {
            acceptCount: 1,
            firstAccepted: timestamp,
            lastAccepted: timestamp,
            totalAdded: safeAddedLines,
            totalDeleted: safeDeletedLines,
            buttonTypes: {
              [normalizedButtonType]: 1,
            },
          });
        }

        // Âú®ÊúÉË©±‰∏≠ËøΩËπ§Ôºå‰∏¶ÂñÆÁç®ËøΩËπ§ÊåâÈàïÈ°ûÂûã
        this.analytics.sessions.push({
          filename,
          addedLines: safeAddedLines,
          deletedLines: safeDeletedLines,
          timestamp,
          buttonType: normalizedButtonType,
          timeSaved: safeTimeSaved,
        });

        // Êõ¥Êñ∞ÊåâÈàïÈ°ûÂûãË®àÊï∏Âô®
        if (!this.analytics.buttonTypeCounts) {
          this.analytics.buttonTypeCounts = {};
        }
        this.analytics.buttonTypeCounts[normalizedButtonType] =
          (this.analytics.buttonTypeCounts[normalizedButtonType] || 0) + 1;

        this.analytics.totalAccepts++;

        this.logToPanel(
          `üìÅ ${filename} (+${safeAddedLines}/-${safeDeletedLines}) [${normalizedButtonType}] [ÁØÄÁúÅ ${this.formatTimeDuration(
            safeTimeSaved
          )}]`,
          'file'
        );
        this.log(
          `Ê™îÊ°àÂ∑≤Êé•ÂèóÔºö${filename} (+${safeAddedLines}/-${safeDeletedLines}) - ÊåâÈàïÔºö${normalizedButtonType} - ÁØÄÁúÅÊôÇÈñìÔºö${this.formatTimeDuration(
            safeTimeSaved
          )}`
        );

        // Â¶ÇÊûúÂàÜÊûêÈù¢ÊùøÂèØË¶ãÔºåÂâáÊõ¥Êñ∞
        if (this.currentTab === 'analytics' || this.currentTab === 'roi') {
          this.updateAnalyticsContent();
        }

        // Êõ¥Êñ∞‰∏ªÈù¢ÊùøÈ†ÅËÖ≥ÁöÑ ROI È°ØÁ§∫
        this.updateMainFooter();

        // ÂÑ≤Â≠òÂà∞ÂÑ≤Â≠òÁ©∫Èñì
        this.saveToStorage();
      }

      // Ê®ôÊ∫ñÂåñÊåâÈàïÈ°ûÂûã‰ª•ÈÄ≤Ë°å‰∏ÄËá¥ÁöÑÂàÜÊûê
      normalizeButtonType(buttonType) {
        if (!buttonType) return 'Êú™Áü•';

        const type = buttonType.toLowerCase().trim();

        // Â∞áËÆäÈ´îÊò†Â∞ÑÂà∞Ê®ôÊ∫ñÈ°ûÂûã
        if (type.includes('accept all')) return 'ÂÖ®ÈÉ®Êé•Âèó';
        if (type.includes('accept')) return 'Êé•Âèó';
        if (type.includes('run command')) return 'Âü∑Ë°åÂëΩ‰ª§';
        if (type.includes('run')) return 'Âü∑Ë°å';
        if (type.includes('apply')) return 'Â•óÁî®';
        if (type.includes('execute')) return 'Âü∑Ë°å';
        if (type.includes('resume')) return 'ÁπºÁ∫åÂ∞çË©±';

        return type;
      }

      createControlPanel() {
        if (this.controlPanel) return;

        this.controlPanel = document.createElement('div');
        this.controlPanel.id = 'auto-accept-control-panel';

        // Âª∫Á´ãÂ∏∂ÊúâÊ®ôÁ±§È†ÅÁöÑÊ®ôÈ†≠
        const header = document.createElement('div');
        header.className = 'aa-header';

        const tabsContainer = document.createElement('div');
        tabsContainer.className = 'aa-tabs';

        const mainTab = document.createElement('button');
        mainTab.className = 'aa-tab aa-tab-active';
        mainTab.textContent = '‰∏ªÈù¢Êùø';
        mainTab.onclick = () => this.switchTab('main');

        const analyticsTab = document.createElement('button');
        analyticsTab.className = 'aa-tab';
        analyticsTab.textContent = 'ÂàÜÊûê';
        analyticsTab.onclick = () => this.switchTab('analytics');

        const roiTab = document.createElement('button');
        roiTab.className = 'aa-tab';
        roiTab.textContent = 'ROI';
        roiTab.onclick = () => this.switchTab('roi');

        tabsContainer.appendChild(mainTab);
        tabsContainer.appendChild(analyticsTab);
        tabsContainer.appendChild(roiTab);

        const headerControls = document.createElement('div');
        headerControls.className = 'aa-header-controls';

        const minimizeBtn = document.createElement('button');
        minimizeBtn.className = 'aa-minimize';
        minimizeBtn.title = 'ÊúÄÂ∞èÂåñ';
        minimizeBtn.textContent = '‚àí';

        const closeBtn = document.createElement('button');
        closeBtn.className = 'aa-close';
        closeBtn.title = 'ÈóúÈñâ';
        closeBtn.textContent = '√ó';

        headerControls.appendChild(minimizeBtn);
        headerControls.appendChild(closeBtn);

        header.appendChild(tabsContainer);
        header.appendChild(headerControls);

        // Âª∫Á´ã‰∏ªÂÖßÂÆπÂçÄÂüü
        const mainContent = document.createElement('div');
        mainContent.className = 'aa-content aa-main-content';

        // ÁãÄÊÖãÈÉ®ÂàÜ
        const status = document.createElement('div');
        status.className = 'aa-status';

        const statusText = document.createElement('span');
        statusText.className = 'aa-status-text';
        statusText.textContent = 'Â∑≤ÂÅúÊ≠¢';

        const clicksText = document.createElement('span');
        clicksText.className = 'aa-clicks';
        clicksText.textContent = '0 Ê¨°ÈªûÊìä';

        status.appendChild(statusText);
        status.appendChild(clicksText);

        // ÊéßÂà∂ÈÉ®ÂàÜ
        const controls = document.createElement('div');
        controls.className = 'aa-controls';

        const startBtn = document.createElement('button');
        startBtn.className = 'aa-btn aa-start';
        startBtn.textContent = 'ÈñãÂßã';

        const stopBtn = document.createElement('button');
        stopBtn.className = 'aa-btn aa-stop';
        stopBtn.textContent = 'ÂÅúÊ≠¢';
        stopBtn.disabled = true;

        const configBtn = document.createElement('button');
        configBtn.className = 'aa-btn aa-config';
        configBtn.textContent = 'Ë®≠ÂÆö';

        controls.appendChild(startBtn);
        controls.appendChild(stopBtn);
        controls.appendChild(configBtn);

        // Ë®≠ÂÆöÈù¢Êùø
        const configPanel = document.createElement('div');
        configPanel.className = 'aa-config-panel';
        configPanel.style.display = 'none';

        const configOptions = [
          { id: 'aa-accept-all', text: 'ÂÖ®ÈÉ®Êé•Âèó', checked: true },
          { id: 'aa-accept', text: 'Êé•Âèó', checked: true },
          { id: 'aa-run', text: 'Âü∑Ë°å', checked: true },
          { id: 'aa-apply', text: 'Â•óÁî®', checked: true },
          { id: 'aa-resume', text: 'ÁπºÁ∫åÂ∞çË©±', checked: true },
        ];

        configOptions.forEach(option => {
          const label = document.createElement('label');
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.id = option.id;
          checkbox.checked = option.checked;

          label.appendChild(checkbox);
          label.appendChild(document.createTextNode(' ' + option.text));
          configPanel.appendChild(label);
        });

        // Êó•Ë™åÈÉ®ÂàÜ
        const log = document.createElement('div');
        log.className = 'aa-log';

        // ‰∏ªÊ®ôÁ±§È†ÅÁöÑ ROI È†ÅËÖ≥
        const roiFooter = document.createElement('div');
        roiFooter.className = 'aa-roi-footer';

        // ‰∏ªÊ®ôÁ±§È†ÅÁöÑÈ≥¥Ë¨ùÈÉ®ÂàÜ
        const creditsDiv = document.createElement('div');
        creditsDiv.className = 'aa-credits';

        const creditsText = document.createElement('small');
        creditsText.textContent = '‰ΩúËÄÖÔºö';

        const creditsLink = document.createElement('a');
        creditsLink.href = 'https://linkedin.com/in/ivalsaraj';
        creditsLink.target = '_blank';
        creditsLink.textContent = '@ivalsaraj';

        creditsText.appendChild(creditsLink);
        creditsDiv.appendChild(creditsText);

        // ÁµÑÂêà‰∏ªÂÖßÂÆπ
        mainContent.appendChild(status);
        mainContent.appendChild(controls);
        mainContent.appendChild(configPanel);
        mainContent.appendChild(log);
        mainContent.appendChild(roiFooter);
        mainContent.appendChild(creditsDiv);

        // Âª∫Á´ãÂàÜÊûêÂÖßÂÆπÂçÄÂüü
        const analyticsContent = document.createElement('div');
        analyticsContent.className = 'aa-content aa-analytics-content';
        analyticsContent.style.display = 'none';

        // ÁµÑÂêàÊâÄÊúâÈÉ®ÂàÜ
        this.controlPanel.appendChild(header);
        this.controlPanel.appendChild(mainContent);
        this.controlPanel.appendChild(analyticsContent);

        this.controlPanel.style.cssText = `
                    position: fixed;
                    top: 100px;
                    right: 20px;
                    width: 280px;
                    background: #1e1e1e;
                    border: 1px solid #333;
                    border-radius: 6px;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                    font-size: 12px;
                    color: #ccc;
                    z-index: 999999;
                    user-select: none;
                    max-height: 500px;
                    display: flex;
                    flex-direction: column;
                `;

        this.addPanelStyles();
        this.setupPanelEvents();
        document.body.appendChild(this.controlPanel);

        // ÂàùÂßãÂåñÂàÜÊûêÂÖßÂÆπ‰∏¶Êõ¥Êñ∞‰∏ªÈ†ÅËÖ≥
        this.updateAnalyticsContent();
        this.updateMainFooter();
      }

      updateMainFooter() {
        const roiFooter = this.controlPanel?.querySelector('.aa-roi-footer');
        if (!roiFooter) return;

        // Ê∏ÖÈô§ÁèæÊúâÂÖßÂÆπ
        while (roiFooter.firstChild) {
          roiFooter.removeChild(roiFooter.firstChild);
        }

        // Ë®àÁÆó ROI ÊåáÊ®ô
        const totalTimeSaved = this.roiTracking.totalTimeSaved || 0;
        const totalAccepts = this.analytics.totalAccepts || 0;
        const sessionDuration = new Date() - this.analytics.sessionStart;

        // ÂÆâÂÖ®Ë®àÁÆó‰ª•ÈÅøÂÖç NaN - Âü∫ÊñºÂÆåÊï¥Â∑•‰ΩúÊµÅÁ®ãË®àÁÆóÊïàÁéá
        const averageManualWorkflowTime = this.roiTracking.averageCompleteWorkflow;
        const totalManualTime = totalAccepts * averageManualWorkflowTime;
        const totalAutomatedTime = totalAccepts * this.roiTracking.averageAutomatedWorkflow;
        const efficiencyGain =
          totalManualTime > 0
            ? ((totalManualTime - totalAutomatedTime) / totalManualTime) * 100
            : 0;

        const title = document.createElement('div');
        title.className = 'aa-roi-footer-title';
        title.textContent = '‚ö° Â∑•‰ΩúÊµÅÁ®ã ROI';

        const stats = document.createElement('div');
        stats.className = 'aa-roi-footer-stats';

        const timeSavedSpan = document.createElement('span');
        timeSavedSpan.textContent = `ÁØÄÁúÅÊôÇÈñìÔºö${this.formatTimeDuration(totalTimeSaved)}`;

        const efficiencySpan = document.createElement('span');
        efficiencySpan.textContent = `Â∑•‰ΩúÊµÅÁ®ãÊïàÁéáÔºö${efficiencyGain.toFixed(1)}%`;

        stats.appendChild(timeSavedSpan);
        stats.appendChild(efficiencySpan);

        roiFooter.appendChild(title);
        roiFooter.appendChild(stats);
      }

      switchTab(tabName) {
        this.currentTab = tabName;

        // Êõ¥Êñ∞Ê®ôÁ±§È†ÅÊåâÈàï
        const tabs = this.controlPanel.querySelectorAll('.aa-tab');
        tabs.forEach(tab => {
          tab.classList.remove('aa-tab-active');
          if (
            tab.textContent.toLowerCase() === tabName ||
            (tabName === 'main' && tab.textContent === '‰∏ªÈù¢Êùø') ||
            (tabName === 'analytics' && tab.textContent === 'ÂàÜÊûê') ||
            (tabName === 'roi' && tab.textContent === 'ROI')
          ) {
            tab.classList.add('aa-tab-active');
          }
        });

        // Êõ¥Êñ∞ÂÖßÂÆπÂèØË¶ãÊÄß
        const mainContent = this.controlPanel.querySelector('.aa-main-content');
        const analyticsContent = this.controlPanel.querySelector('.aa-analytics-content');

        if (tabName === 'main') {
          mainContent.style.display = 'block';
          analyticsContent.style.display = 'none';
        } else if (tabName === 'analytics') {
          mainContent.style.display = 'none';
          analyticsContent.style.display = 'block';
          this.updateAnalyticsContent();
        } else if (tabName === 'roi') {
          mainContent.style.display = 'none';
          analyticsContent.style.display = 'block';
          this.updateAnalyticsContent();
        }
      }

      updateAnalyticsContent() {
        const analyticsContent = this.controlPanel.querySelector('.aa-analytics-content');
        if (!analyticsContent) return;

        // Ê∏ÖÈô§ÁèæÊúâÂÖßÂÆπ
        analyticsContent.textContent = '';

        if (this.currentTab === 'analytics') {
          this.renderAnalyticsTab(analyticsContent);
        } else if (this.currentTab === 'roi') {
          this.renderROITab(analyticsContent);
        }
      }

      renderAnalyticsTab(container) {
        const now = new Date();
        const sessionDuration = Math.round((now - this.analytics.sessionStart) / 1000 / 60); // ÂàÜÈêò

        // Ë®àÁÆóÁ∏ΩË®à
        let totalFiles = this.analytics.files.size;
        let totalAdded = 0;
        let totalDeleted = 0;

        this.analytics.files.forEach(fileData => {
          totalAdded += fileData.totalAdded;
          totalDeleted += fileData.totalDeleted;
        });

        // Âª∫Á´ãÂàÜÊûêÊëòË¶Å
        const summaryDiv = document.createElement('div');
        summaryDiv.className = 'aa-analytics-summary';

        const summaryTitle = document.createElement('h4');
        summaryTitle.textContent = 'üìä ÊúÉË©±ÂàÜÊûê';
        summaryDiv.appendChild(summaryTitle);

        const stats = [
          { label: 'ÊúÉË©±ÊôÇÈï∑Ôºö', value: `${sessionDuration}ÂàÜÈêò` },
          { label: 'Á∏ΩÊé•ÂèóÊ¨°Êï∏Ôºö', value: `${this.analytics.totalAccepts}` },
          { label: 'Â∑≤‰øÆÊîπÊ™îÊ°àÔºö', value: `${totalFiles}` },
          {
            label: 'Â¢ûÂä†Ë°åÊï∏Ôºö',
            value: `+${totalAdded}`,
            class: 'aa-stat-added',
          },
          {
            label: 'Âà™Èô§Ë°åÊï∏Ôºö',
            value: `-${totalDeleted}`,
            class: 'aa-stat-deleted',
          },
        ];

        stats.forEach(stat => {
          const statDiv = document.createElement('div');
          statDiv.className = 'aa-stat';

          const labelSpan = document.createElement('span');
          labelSpan.className = 'aa-stat-label';
          labelSpan.textContent = stat.label;

          const valueSpan = document.createElement('span');
          valueSpan.className = `aa-stat-value ${stat.class || ''}`;
          valueSpan.textContent = stat.value;

          statDiv.appendChild(labelSpan);
          statDiv.appendChild(valueSpan);
          summaryDiv.appendChild(statDiv);
        });

        // Ê∑ªÂä†ÊåâÈàïÈ°ûÂûãÁ¥∞ÂàÜ
        if (
          this.analytics.buttonTypeCounts &&
          Object.keys(this.analytics.buttonTypeCounts).length > 0
        ) {
          const buttonTypeDiv = document.createElement('div');
          buttonTypeDiv.className = 'aa-button-types';

          const buttonTypeTitle = document.createElement('h5');
          buttonTypeTitle.textContent = 'üéØ ÊåâÈàïÈ°ûÂûã';
          buttonTypeTitle.style.cssText = 'margin: 8px 0 4px 0; font-size: 11px; color: #ddd;';
          buttonTypeDiv.appendChild(buttonTypeTitle);

          Object.entries(this.analytics.buttonTypeCounts).forEach(([type, count]) => {
            const typeDiv = document.createElement('div');
            typeDiv.className = 'aa-stat aa-button-type-stat';
            typeDiv.style.cssText = 'font-size: 10px; padding: 2px 0;';

            const labelSpan = document.createElement('span');
            labelSpan.className = 'aa-stat-label';
            labelSpan.textContent = `${type}:`;

            const valueSpan = document.createElement('span');
            valueSpan.className = 'aa-stat-value';
            valueSpan.textContent = `${count}Ê¨°`;

            // Ê∑ªÂä†ÁâπÂÆöÈ°ûÂûãÁöÑÊ®£Âºè
            if (type === 'Êé•Âèó' || type === 'ÂÖ®ÈÉ®Êé•Âèó') {
              valueSpan.style.color = '#4CAF50';
            } else if (type === 'Âü∑Ë°å' || type === 'Âü∑Ë°åÂëΩ‰ª§') {
              valueSpan.style.color = '#FF9800';
            } else if (type === 'ÁπºÁ∫åÂ∞çË©±') {
              valueSpan.style.color = '#2196F3';
            } else {
              valueSpan.style.color = '#9C27B0';
            }

            typeDiv.appendChild(labelSpan);
            typeDiv.appendChild(valueSpan);
            buttonTypeDiv.appendChild(typeDiv);
          });

          summaryDiv.appendChild(buttonTypeDiv);
        }

        // Âª∫Á´ãÊ™îÊ°àÈÉ®ÂàÜ
        const filesDiv = document.createElement('div');
        filesDiv.className = 'aa-analytics-files';

        const filesTitle = document.createElement('h4');
        filesTitle.textContent = 'üìÅ Ê™îÊ°àÊ¥ªÂãï';
        filesDiv.appendChild(filesTitle);

        const filesList = document.createElement('div');
        filesList.className = 'aa-files-list';
        this.renderFilesList(filesList);
        filesDiv.appendChild(filesList);

        // Âª∫Á´ãÊìç‰ΩúÈÉ®ÂàÜ
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'aa-analytics-actions';

        const exportBtn = document.createElement('button');
        exportBtn.className = 'aa-btn aa-btn-small';
        exportBtn.textContent = 'ÂåØÂá∫Ë≥áÊñô';
        exportBtn.onclick = () => this.exportAnalytics();

        const clearBtn = document.createElement('button');
        clearBtn.className = 'aa-btn aa-btn-small';
        clearBtn.textContent = 'Ê∏ÖÈô§Ë≥áÊñô';
        clearBtn.onclick = () => this.clearAnalytics();

        actionsDiv.appendChild(exportBtn);
        actionsDiv.appendChild(clearBtn);

        // Âª∫Á´ãÈ≥¥Ë¨ùÈÉ®ÂàÜ
        const creditsDiv = document.createElement('div');
        creditsDiv.className = 'aa-credits';

        const creditsText = document.createElement('small');
        creditsText.textContent = '‰ΩúËÄÖÔºö';

        const creditsLink = document.createElement('a');
        creditsLink.href = 'https://linkedin.com/in/ivalsaraj';
        creditsLink.target = '_blank';
        creditsLink.textContent = '@ivalsaraj';

        creditsText.appendChild(creditsLink);
        creditsDiv.appendChild(creditsText);

        // ÈôÑÂä†ÊâÄÊúâÈÉ®ÂàÜ
        container.appendChild(summaryDiv);
        container.appendChild(filesDiv);
        container.appendChild(actionsDiv);
        container.appendChild(creditsDiv);
      }

      renderROITab(container) {
        const now = new Date();
        const sessionDuration = now - this.analytics.sessionStart;

        // ‰ΩøÁî®ÂÆâÂÖ®ÂÇôÁî®ÂÄºË®àÁÆó ROI ÊåáÊ®ô
        const totalTimeSaved = this.roiTracking.totalTimeSaved || 0;
        const totalAccepts = this.analytics.totalAccepts || 0;
        const averageTimePerClick = totalAccepts > 0 ? totalTimeSaved / totalAccepts : 0;
        const productivityGain = sessionDuration > 0 ? (totalTimeSaved / sessionDuration) * 100 : 0;

        // Âª∫Á´ã ROI ÊëòË¶Å
        const summaryDiv = document.createElement('div');
        summaryDiv.className = 'aa-roi-summary';

        const summaryTitle = document.createElement('h4');
        summaryTitle.textContent = '‚ö° ÂÆåÊï¥Â∑•‰ΩúÊµÅÁ®ã ROI';
        summaryDiv.appendChild(summaryTitle);

        // Ê∑ªÂä†Â∑•‰ΩúÊµÅÁ®ãÊ∏¨ÈáèË™™Êòé
        const explanationDiv = document.createElement('div');
        explanationDiv.className = 'aa-roi-explanation';
        explanationDiv.style.cssText =
          'font-size: 10px; color: #888; margin-bottom: 8px; line-height: 1.3;';
        explanationDiv.textContent =
          'Ë°°ÈáèÂÆåÊï¥ÁöÑ AI Â∑•‰ΩúÊµÅÁ®ãÔºö‰ΩøÁî®ËÄÖÊèêÁ§∫ ‚Üí Cursor ÁîüÊàê ‚Üí ÊâãÂãïËßÄÁúã/ÈªûÊìä vs Ëá™ÂãïÊé•Âèó';
        summaryDiv.appendChild(explanationDiv);

        const roiStats = [
          {
            label: 'Á∏ΩÁØÄÁúÅÊôÇÈñìÔºö',
            value: this.formatTimeDuration(totalTimeSaved),
            class: 'aa-roi-highlight',
          },
          {
            label: 'ÊúÉË©±ÊôÇÈï∑Ôºö',
            value: this.formatTimeDuration(sessionDuration),
          },
          {
            label: 'ÊØèÊ¨°ÈªûÊìäÂπ≥ÂùáÁØÄÁúÅÔºö',
            value: this.formatTimeDuration(averageTimePerClick),
          },
          {
            label: 'ÁîüÁî¢ÂäõÊèêÂçáÔºö',
            value: `${productivityGain.toFixed(1)}%`,
            class: 'aa-roi-percentage',
          },
          { label: 'Ëá™ÂãïÂåñÈªûÊìäÊ¨°Êï∏Ôºö', value: `${totalAccepts}` },
        ];

        roiStats.forEach(stat => {
          const statDiv = document.createElement('div');
          statDiv.className = 'aa-stat';

          const labelSpan = document.createElement('span');
          labelSpan.className = 'aa-stat-label';
          labelSpan.textContent = stat.label;

          const valueSpan = document.createElement('span');
          valueSpan.className = `aa-stat-value ${stat.class || ''}`;
          valueSpan.textContent = stat.value;

          statDiv.appendChild(labelSpan);
          statDiv.appendChild(valueSpan);
          summaryDiv.appendChild(statDiv);
        });

        // Âª∫Á´ãÂΩ±ÈüøÂàÜÊûê
        const impactDiv = document.createElement('div');
        impactDiv.className = 'aa-roi-impact';

        const impactTitle = document.createElement('h4');
        impactTitle.textContent = 'üìà ÂΩ±ÈüøÂàÜÊûê';
        impactDiv.appendChild(impactTitle);

        const impactText = document.createElement('div');
        impactText.className = 'aa-roi-text';

        // ‰ΩøÁî®ÂÆâÂÖ®Èô§Ê≥ïË®àÁÆó‰∏çÂêåÊÉÖÂ¢É
        const hourlyRate = sessionDuration > 0 ? totalTimeSaved / sessionDuration : 0;
        const dailyProjection = hourlyRate * (8 * 60 * 60 * 1000); // 8 Â∞èÊôÇÂ∑•‰ΩúÊó•
        const weeklyProjection = dailyProjection * 5;
        const monthlyProjection = dailyProjection * 22; // Â∑•‰ΩúÊó•

        const scenarios = [
          { period: 'ÊØèÊó• (8Â∞èÊôÇ)', saved: dailyProjection },
          { period: 'ÊØèÈÄ± (5Â§©)', saved: weeklyProjection },
          { period: 'ÊØèÊúà (22Â§©)', saved: monthlyProjection },
        ];

        scenarios.forEach(scenario => {
          const scenarioDiv = document.createElement('div');
          scenarioDiv.className = 'aa-roi-scenario';
          scenarioDiv.textContent = `${
            scenario.period
          }ÔºöÁØÄÁúÅ ${this.formatTimeDuration(scenario.saved)}`;
          impactText.appendChild(scenarioDiv);
        });

        impactDiv.appendChild(impactText);

        // ÊâãÂãï vs Ëá™ÂãïÊØîËºÉ
        const comparisonDiv = document.createElement('div');
        comparisonDiv.className = 'aa-roi-comparison';

        const comparisonTitle = document.createElement('h4');
        comparisonTitle.textContent = 'üîÑ ÂÆåÊï¥Â∑•‰ΩúÊµÅÁ®ãÊØîËºÉ';
        comparisonDiv.appendChild(comparisonTitle);

        // Ê∑ªÂä†Â∑•‰ΩúÊµÅÁ®ãÂàÜËß£Ë™™Êòé
        const workflowBreakdown = document.createElement('div');
        workflowBreakdown.className = 'aa-workflow-breakdown';
        workflowBreakdown.style.cssText =
          'font-size: 10px; color: #888; margin-bottom: 8px; line-height: 1.3;';

        const manualLine = document.createElement('div');
        manualLine.textContent = 'ÊâãÂãïÔºöËßÄÁúãÁîüÊàê + ÊâæÊåâÈàï + ÈªûÊìä + ÂàáÊèõ (~30Áßí)';
        workflowBreakdown.appendChild(manualLine);

        const automatedLine = document.createElement('div');
        automatedLine.textContent = 'Ëá™ÂãïÔºöÂú®ÊÇ®Á∑®Á¢ºÊôÇÂç≥ÊôÇÂÅµÊ∏¨ÂíåÈªûÊìä (~0.1Áßí)';
        workflowBreakdown.appendChild(automatedLine);

        comparisonDiv.appendChild(workflowBreakdown);

        const manualTime = totalAccepts * this.roiTracking.averageCompleteWorkflow;
        const automatedTime = totalAccepts * this.roiTracking.averageAutomatedWorkflow;

        const comparisonStats = [
          {
            label: 'ÊâãÂãïÂ∑•‰ΩúÊµÅÁ®ãÊôÇÈñìÔºö',
            value: this.formatTimeDuration(manualTime),
            class: 'aa-roi-manual',
          },
          {
            label: 'Ëá™ÂãïÂ∑•‰ΩúÊµÅÁ®ãÊôÇÈñìÔºö',
            value: this.formatTimeDuration(automatedTime),
            class: 'aa-roi-auto',
          },
          {
            label: 'Â∑•‰ΩúÊµÅÁ®ãÊïàÁéáÔºö',
            value: `${
              manualTime > 0
                ? (((manualTime - automatedTime) / manualTime) * 100).toFixed(1)
                : '0.0'
            }%`,
            class: 'aa-roi-highlight',
          },
        ];

        comparisonStats.forEach(stat => {
          const statDiv = document.createElement('div');
          statDiv.className = 'aa-stat';

          const labelSpan = document.createElement('span');
          labelSpan.className = 'aa-stat-label';
          labelSpan.textContent = stat.label;

          const valueSpan = document.createElement('span');
          valueSpan.className = `aa-stat-value ${stat.class || ''}`;
          valueSpan.textContent = stat.value;

          statDiv.appendChild(labelSpan);
          statDiv.appendChild(valueSpan);
          comparisonDiv.appendChild(statDiv);
        });

        // ‰πüÁÇ∫ ROI Ê®ôÁ±§È†ÅÂª∫Á´ãÈ≥¥Ë¨ùÈÉ®ÂàÜ
        const creditsDiv = document.createElement('div');
        creditsDiv.className = 'aa-credits';

        const creditsText = document.createElement('small');
        creditsText.textContent = '‰ΩúËÄÖÔºö';

        const creditsLink = document.createElement('a');
        creditsLink.href = 'https://linkedin.com/in/ivalsaraj';
        creditsLink.target = '_blank';
        creditsLink.textContent = '@ivalsaraj';

        creditsText.appendChild(creditsLink);
        creditsDiv.appendChild(creditsText);

        // ÈôÑÂä†ÊâÄÊúâÈÉ®ÂàÜ
        container.appendChild(summaryDiv);
        container.appendChild(impactDiv);
        container.appendChild(comparisonDiv);
        container.appendChild(creditsDiv);
      }

      renderFilesList(container) {
        if (this.analytics.files.size === 0) {
          const noFilesDiv = document.createElement('div');
          noFilesDiv.className = 'aa-no-files';
          noFilesDiv.textContent = 'Â∞öÁÑ°Ê™îÊ°àË¢´‰øÆÊîπ';
          container.appendChild(noFilesDiv);
          return;
        }

        const sortedFiles = Array.from(this.analytics.files.entries()).sort(
          (a, b) => b[1].lastAccepted - a[1].lastAccepted
        );

        sortedFiles.forEach(([filename, data]) => {
          const timeAgo = this.getTimeAgo(data.lastAccepted);

          const fileItem = document.createElement('div');
          fileItem.className = 'aa-file-item';

          const fileName = document.createElement('div');
          fileName.className = 'aa-file-name';
          fileName.textContent = filename;

          const fileStats = document.createElement('div');
          fileStats.className = 'aa-file-stats';

          const fileCount = document.createElement('span');
          fileCount.className = 'aa-file-count';
          fileCount.textContent = `${data.acceptCount}Ê¨°`;

          const fileChanges = document.createElement('span');
          fileChanges.className = 'aa-file-changes';
          fileChanges.textContent = `+${data.totalAdded}/-${data.totalDeleted}`;

          const fileTime = document.createElement('span');
          fileTime.className = 'aa-file-time';
          fileTime.textContent = timeAgo;

          fileStats.appendChild(fileCount);
          fileStats.appendChild(fileChanges);
          fileStats.appendChild(fileTime);

          fileItem.appendChild(fileName);
          fileItem.appendChild(fileStats);

          container.appendChild(fileItem);
        });
      }

      getTimeAgo(date) {
        const now = new Date();
        const diff = Math.round((now - date) / 1000); // Áßí

        if (diff < 60) return `${diff}ÁßíÂâç`;
        if (diff < 3600) return `${Math.round(diff / 60)}ÂàÜÂâç`;
        if (diff < 86400) return `${Math.round(diff / 3600)}Â∞èÊôÇÂâç`;
        return `${Math.round(diff / 86400)}Â§©Ââç`;
      }

      exportAnalytics() {
        const data = {
          session: {
            start: this.analytics.sessionStart,
            duration: new Date() - this.analytics.sessionStart,
            totalAccepts: this.analytics.totalAccepts,
          },
          files: Object.fromEntries(this.analytics.files),
          sessions: this.analytics.sessions,
          config: this.config,
          exportedAt: new Date(),
        };

        const blob = new Blob([JSON.stringify(data, null, 2)], {
          type: 'application/json',
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `cursor-auto-accept-extension-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);

        this.logToPanel('üì• ÂàÜÊûêË≥áÊñôÂ∑≤ÂåØÂá∫', 'info');
      }

      clearAnalytics() {
        if (confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâÂàÜÊûêË≥áÊñôÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ')) {
          this.analytics.files.clear();
          this.analytics.sessions = [];
          this.analytics.totalAccepts = 0;
          this.analytics.sessionStart = new Date();
          this.updateAnalyticsContent();
          this.logToPanel('üóëÔ∏è ÂàÜÊûêË≥áÊñôÂ∑≤Ê∏ÖÈô§', 'warning');
        }
      }

      addPanelStyles() {
        if (document.getElementById('auto-accept-styles')) return;

        const style = document.createElement('style');
        style.id = 'auto-accept-styles';
        style.textContent = `
                    .aa-header {
                        background: #2d2d2d;
                        padding: 6px 10px;
                        border-radius: 5px 5px 0 0;
                        cursor: move;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        border-bottom: 1px solid #333;
                    }
                    
                    .aa-tabs {
                        display: flex;
                        gap: 4px;
                    }
                    
                    .aa-tab {
                        background: #444;
                        border: none;
                        color: #ccc;
                        font-size: 11px;
                        cursor: pointer;
                        padding: 4px 8px;
                        border-radius: 3px;
                        transition: all 0.2s;
                    }
                    
                    .aa-tab:hover {
                        background: #555;
                    }
                    
                    .aa-tab-active {
                        background: #0d7377 !important;
                        color: white !important;
                    }
                    
                    .aa-header-controls {
                        display: flex;
                        gap: 4px;
                    }
                    
                    .aa-title {
                        font-weight: 500;
                        color: #fff;
                        font-size: 12px;
                    }
                    .aa-minimize, .aa-close {
                        background: #444;
                        border: none;
                        color: #ccc;
                        font-size: 12px;
                        font-weight: bold;
                        cursor: pointer;
                        padding: 2px 5px;
                        border-radius: 2px;
                        line-height: 1;
                        width: 16px;
                        height: 16px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }
                    .aa-minimize:hover, .aa-close:hover {
                        background: #555;
                    }
                    .aa-close:hover {
                        background: #dc3545;
                        color: white;
                    }
                    .aa-content {
                        padding: 12px;
                        overflow-y: auto;
                        flex: 1;
                    }
                    .aa-status {
                        display: flex;
                        justify-content: space-between;
                        margin-bottom: 10px;
                        padding: 6px 8px;
                        background: #252525;
                        border-radius: 4px;
                        font-size: 11px;
                    }
                    .aa-status-text.running {
                        color: #4CAF50;
                        font-weight: 500;
                    }
                    .aa-status-text.stopped {
                        color: #f44336;
                    }
                    .aa-clicks {
                        color: #888;
                    }
                    .aa-controls {
                        display: flex;
                        gap: 6px;
                        margin-bottom: 10px;
                    }
                    .aa-btn {
                        flex: 1;
                        padding: 6px 12px;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 11px;
                        font-weight: 500;
                        transition: all 0.2s;
                    }
                    .aa-btn-small {
                        flex: none;
                        padding: 4px 8px;
                        font-size: 10px;
                    }
                    .aa-start {
                        background: #4CAF50;
                        color: white;
                    }
                    .aa-start:hover:not(:disabled) {
                        background: #45a049;
                    }
                    .aa-stop {
                        background: #f44336;
                        color: white;
                    }
                    .aa-stop:hover:not(:disabled) {
                        background: #da190b;
                    }
                    .aa-config {
                        background: #2196F3;
                        color: white;
                    }
                    .aa-config:hover:not(:disabled) {
                        background: #1976D2;
                    }
                    .aa-btn:disabled {
                        opacity: 0.5;
                        cursor: not-allowed;
                    }
                    .aa-config-panel {
                        background: #252525;
                        border-radius: 4px;
                        padding: 8px;
                        margin-bottom: 10px;
                    }
                    .aa-config-panel label {
                        display: block;
                        margin-bottom: 4px;
                        font-size: 11px;
                        cursor: pointer;
                    }
                    .aa-config-panel input[type="checkbox"] {
                        margin-right: 6px;
                    }
                    .aa-log {
                        background: #252525;
                        border-radius: 4px;
                        padding: 8px;
                        height: 120px;
                        overflow-y: auto;
                        font-size: 10px;
                        line-height: 1.3;
                    }
                    .aa-log-entry {
                        margin-bottom: 2px;
                        padding: 2px 4px;
                        border-radius: 2px;
                    }
                    .aa-log-entry.info {
                        color: #4CAF50;
                    }
                    .aa-log-entry.warning {
                        color: #FF9800;
                    }
                    .aa-log-entry.error {
                        color: #f44336;
                    }
                    .aa-log-entry.file {
                        color: #2196F3;
                        background: rgba(33, 150, 243, 0.1);
                    }
                    
                    /* ÂàÜÊûêÈ†ÅÈù¢Ê®£Âºè */
                    .aa-analytics-summary {
                        background: #252525;
                        border-radius: 4px;
                        padding: 8px;
                        margin-bottom: 10px;
                    }
                    
                    .aa-analytics-summary h4 {
                        margin: 0 0 8px 0;
                        font-size: 12px;
                        color: #fff;
                    }
                    
                    .aa-stat {
                        display: flex;
                        justify-content: space-between;
                        margin-bottom: 4px;
                        font-size: 11px;
                    }
                    
                    .aa-stat-label {
                        color: #888;
                    }
                    
                    .aa-stat-value {
                        color: #fff;
                        font-weight: 500;
                    }
                    
                    .aa-stat-added {
                        color: #4CAF50;
                    }
                    
                    .aa-stat-deleted {
                        color: #f44336;
                    }
                    
                    .aa-analytics-files {
                        background: #252525;
                        border-radius: 4px;
                        padding: 8px;
                        margin-bottom: 10px;
                    }
                    
                    .aa-analytics-files h4 {
                        margin: 0 0 8px 0;
                        font-size: 12px;
                        color: #fff;
                    }
                    
                    .aa-files-list {
                        max-height: 150px;
                        overflow-y: auto;
                    }
                    
                    .aa-file-item {
                        padding: 4px 0;
                        border-bottom: 1px solid #333;
                    }
                    
                    .aa-file-item:last-child {
                        border-bottom: none;
                    }
                    
                    .aa-file-name {
                        font-size: 11px;
                        color: #fff;
                        font-weight: 500;
                        margin-bottom: 2px;
                        word-break: break-all;
                    }
                    
                    .aa-file-stats {
                        display: flex;
                        gap: 8px;
                        font-size: 10px;
                        color: #888;
                    }
                    
                    .aa-file-count {
                        background: #444;
                        padding: 1px 4px;
                        border-radius: 2px;
                        color: #ccc;
                    }
                    
                    .aa-file-changes {
                        color: #2196F3;
                    }
                    
                    .aa-file-time {
                        margin-left: auto;
                    }
                    
                    .aa-no-files {
                        color: #888;
                        font-size: 11px;
                        text-align: center;
                        padding: 20px;
                    }
                    
                    .aa-analytics-actions {
                        display: flex;
                        gap: 6px;
                        margin-bottom: 10px;
                    }
                    
                    .aa-analytics-actions .aa-btn {
                        background: #444;
                        color: #ccc;
                    }
                    
                    .aa-analytics-actions .aa-btn:hover {
                        background: #555;
                    }
                    
                    .aa-credits {
                        text-align: center;
                        padding: 8px;
                        border-top: 1px solid #333;
                        color: #666;
                    }
                    
                    .aa-credits a {
                        color: #2196F3;
                        text-decoration: none;
                    }
                    
                    .aa-credits a:hover {
                        text-decoration: underline;
                    }
                    
                    /* ROI Ê®ôÁ±§È†ÅÊ®£Âºè */
                    .aa-roi-summary, .aa-roi-impact, .aa-roi-comparison {
                        margin-bottom: 12px;
                        padding: 8px;
                        background: #333;
                        border-radius: 4px;
                    }
                    
                    .aa-roi-highlight {
                        color: #4CAF50 !important;
                        font-weight: 600;
                    }
                    
                    .aa-roi-percentage {
                        color: #2196F3 !important;
                        font-weight: 600;
                    }
                    
                    .aa-roi-manual {
                        color: #FF9800 !important;
                    }
                    
                    .aa-roi-auto {
                        color: #4CAF50 !important;
                    }
                    
                    .aa-roi-text {
                        margin-top: 8px;
                    }
                    
                    .aa-roi-scenario {
                        margin: 4px 0;
                        padding: 4px;
                        background: #444;
                        border-radius: 3px;
                        font-size: 11px;
                        color: #ccc;
                    }
                    
                    /* ROI È†ÅËÖ≥Ê®£Âºè (Áî®Êñº‰∏ªÊ®ôÁ±§È†Å) */
                    .aa-roi-footer {
                        margin-top: 8px;
                        padding: 6px 8px;
                        background: #2d2d2d;
                        border-radius: 4px;
                        border-top: 1px solid #444;
                    }
                    
                    .aa-roi-footer-title {
                        font-size: 10px;
                        color: #fff;
                        font-weight: 600;
                        margin-bottom: 4px;
                    }
                    
                    .aa-roi-footer-stats {
                        display: flex;
                        justify-content: space-between;
                        font-size: 9px;
                        color: #888;
                    }
                    
                    .aa-roi-footer-stats span {
                        color: #4CAF50;
                    }
                    
                    /* ÊúÄÂ∞èÂåñÂäüËÉΩ */
                    #auto-accept-control-panel.aa-minimized .aa-content {
                        display: none;
                    }
                    
                    #auto-accept-control-panel.aa-minimized {
                        height: auto;
                        max-height: none;
                    }
                `;
        document.head.appendChild(style);
      }

      setupPanelEvents() {
        const header = this.controlPanel.querySelector('.aa-header');
        const minimizeBtn = this.controlPanel.querySelector('.aa-minimize');
        const closeBtn = this.controlPanel.querySelector('.aa-close');
        const startBtn = this.controlPanel.querySelector('.aa-start');
        const stopBtn = this.controlPanel.querySelector('.aa-stop');
        const configBtn = this.controlPanel.querySelector('.aa-config');
        const configPanel = this.controlPanel.querySelector('.aa-config-panel');

        // ÊãñÊõ≥ÂäüËÉΩ
        header.addEventListener('mousedown', e => {
          if (e.target === minimizeBtn || e.target === closeBtn) return;
          this.isDragging = true;
          const rect = this.controlPanel.getBoundingClientRect();
          this.dragOffset.x = e.clientX - rect.left;
          this.dragOffset.y = e.clientY - rect.top;
          e.preventDefault();
        });

        document.addEventListener('mousemove', e => {
          if (!this.isDragging) return;
          const x = e.clientX - this.dragOffset.x;
          const y = e.clientY - this.dragOffset.y;
          this.controlPanel.style.left =
            Math.max(0, Math.min(window.innerWidth - this.controlPanel.offsetWidth, x)) + 'px';
          this.controlPanel.style.top =
            Math.max(0, Math.min(window.innerHeight - this.controlPanel.offsetHeight, y)) + 'px';
          this.controlPanel.style.right = 'auto';
        });

        document.addEventListener('mouseup', () => {
          this.isDragging = false;
        });

        // ÊéßÂà∂ÊåâÈàï
        minimizeBtn.addEventListener('click', () => {
          this.controlPanel.classList.toggle('aa-minimized');
        });

        closeBtn.addEventListener('click', () => {
          this.hideControlPanel();
        });

        startBtn.addEventListener('click', () => {
          this.start();
        });

        stopBtn.addEventListener('click', () => {
          this.stop();
        });

        configBtn.addEventListener('click', () => {
          configPanel.style.display = configPanel.style.display === 'none' ? 'block' : 'none';
        });

        // Ë®≠ÂÆöË§áÈÅ∏Ê°Ü
        const checkboxes = this.controlPanel.querySelectorAll(
          '.aa-config-panel input[type="checkbox"]'
        );
        checkboxes.forEach(checkbox => {
          checkbox.addEventListener('change', () => {
            const configMap = {
              'aa-accept-all': 'enableAcceptAll',
              'aa-accept': 'enableAccept',
              'aa-run': 'enableRun',
              'aa-apply': 'enableApply',
              'aa-resume': 'enableResume',
            };
            const configKey = configMap[checkbox.id];
            if (configKey) {
              this.config[configKey] = checkbox.checked;
              this.config.enableRunCommand = this.config.enableRun;
              this.config.enableExecute = this.config.enableApply;
            }
          });
        });
      }

      updatePanelStatus() {
        if (!this.controlPanel) return;

        const statusText = this.controlPanel.querySelector('.aa-status-text');
        const clicksText = this.controlPanel.querySelector('.aa-clicks');
        const startBtn = this.controlPanel.querySelector('.aa-start');
        const stopBtn = this.controlPanel.querySelector('.aa-stop');

        if (this.isRunning) {
          statusText.textContent = 'Âü∑Ë°å‰∏≠';
          statusText.className = 'aa-status-text running';
          startBtn.disabled = true;
          stopBtn.disabled = false;
        } else {
          statusText.textContent = 'Â∑≤ÂÅúÊ≠¢';
          statusText.className = 'aa-status-text stopped';
          startBtn.disabled = false;
          stopBtn.disabled = true;
        }

        clicksText.textContent = `${this.totalClicks} Ê¨°ÈªûÊìä`;
      }

      logToPanel(message, type = 'info') {
        if (!this.controlPanel) return;

        // Âª∫Á´ãÂîØ‰∏ÄÁöÑË®äÊÅØÈçµ‰ª•Èò≤Ê≠¢ÈáçË§á
        const messageKey = `${type}:${message}`;
        const now = Date.now();

        // Â¶ÇÊûúÂú®ÈÅéÂéª 2 ÁßíÂÖßË®òÈåÑ‰∫ÜÁõ∏ÂêåÁöÑË®äÊÅØÔºåÂâáË∑≥ÈÅé
        if (this.loggedMessages.has(messageKey)) {
          return;
        }

        // Ê∑ªÂä†Âà∞Â∑≤Ë®òÈåÑÁöÑË®äÊÅØ‰∏≠Ôºå‰∏¶Ê∏ÖÁêÜËàäÊ¢ùÁõÆ
        this.loggedMessages.add(messageKey);
        setTimeout(() => this.loggedMessages.delete(messageKey), 2000);

        const logContainer = this.controlPanel.querySelector('.aa-log');
        const logEntry = document.createElement('div');
        logEntry.className = `aa-log-entry ${type}`;
        logEntry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;

        logContainer.appendChild(logEntry);
        logContainer.scrollTop = logContainer.scrollHeight;

        // Âè™‰øùÁïôÊúÄÂæå 20 ÂÄãÊ¢ùÁõÆ
        while (logContainer.children.length > 20) {
          logContainer.removeChild(logContainer.firstChild);
        }
      }

      showControlPanel() {
        if (!this.controlPanel) this.createControlPanel();
        this.controlPanel.style.display = 'flex';
      }

      hideControlPanel() {
        if (this.controlPanel) {
          this.controlPanel.style.display = 'none';
        }
      }

      log(message) {
        const timestamp = new Date().toISOString();
        const prefix = '[AutoAccept]';
        const fullMessage = `${prefix} ${timestamp} - ${message}`;

        // ÊéßÂà∂Âè∞Êó•Ë™å
        console.log(fullMessage);

        // Èù¢ÊùøÊó•Ë™å
        this.logToPanel(message, 'info');
      }

      // Â∞ãÊâæËº∏ÂÖ•Ê°Ü‰∏¶Ê™¢Êü•ÂÖ∂ÂâçÈù¢ÁöÑÂÖÑÂºüÂÖÉÁ¥†ÊòØÂê¶ÊúâÊåâÈàï
      findAcceptButtons() {
        const buttons = [];

        // Â∞ãÊâæËº∏ÂÖ•Ê°Ü
        const inputBox = document.querySelector('div.full-input-box');
        if (!inputBox) {
          this.log('Êú™ÊâæÂà∞Ëº∏ÂÖ•Ê°Ü');
          return buttons;
        }

        // Ê™¢Êü•ÂâçÈù¢ÁöÑÂÖÑÂºüÂÖÉÁ¥†ÊòØÂê¶ÊúâÂ∏∏Ë¶èÊåâÈàï
        let currentElement = inputBox.previousElementSibling;
        let searchDepth = 0;

        while (currentElement && searchDepth < 5) {
          // Â∞ãÊâæ‰ªª‰ΩïÂåÖÂê´ "Accept" ÊñáÂ≠óÁöÑÂèØÈªûÊìäÂÖÉÁ¥†
          const acceptElements = this.findAcceptInElement(currentElement);
          buttons.push(...acceptElements);

          currentElement = currentElement.previousElementSibling;
          searchDepth++;
        }

        // Â¶ÇÊûúÂïüÁî®Ôºå‰πüÊêúÂ∞ãË®äÊÅØÊ∞£Ê≥°‰∏≠ÁöÑ "ÁπºÁ∫åÂ∞çË©±" ÈÄ£Áµê
        if (this.config.enableResume) {
          const resumeLinks = this.findResumeLinks();
          buttons.push(...resumeLinks);
        }

        return buttons;
      }

      // Âú®ÁâπÂÆöÂÖÉÁ¥†‰∏≠Â∞ãÊâæÊé•ÂèóÊåâÈàï
      findAcceptInElement(element) {
        const buttons = [];

        // ÂèñÂæóÊâÄÊúâÂèØÈªûÊìäÂÖÉÁ¥† (divs, buttons, Â∏∂Êúâ click ËôïÁêÜÂô®ÁöÑ spans)
        const clickableSelectors = [
          'div[class*="button"]',
          'button',
          'div[onclick]',
          'div[style*="cursor: pointer"]',
          'div[style*="cursor:pointer"]',
          '[class*="anysphere"]',
          '[class*="cursor-button"]',
          '[class*="text-button"]',
          '[class*="primary-button"]',
          '[class*="secondary-button"]',
        ];

        for (const selector of clickableSelectors) {
          const elements = element.querySelectorAll(selector);
          for (const el of elements) {
            if (this.isAcceptButton(el)) {
              buttons.push(el);
            }
          }
        }

        // ÂêåÊôÇÊ™¢Êü•ÂÖÉÁ¥†Êú¨Ë∫´
        if (this.isAcceptButton(element)) {
          buttons.push(element);
        }

        return buttons;
      }

      // Ê™¢Êü•ÂÖÉÁ¥†ÊòØÂê¶ÁÇ∫Êé•ÂèóÊåâÈàï
      isAcceptButton(element) {
        if (!element || !element.textContent) return false;

        // È¶ñÂÖàÊ™¢Êü•ÂÆÉÊòØÂê¶ÁÇ∫ "ÁπºÁ∫åÂ∞çË©±" ÈÄ£Áµê
        if (this.config.enableResume && this.isResumeLink(element)) {
          return true;
        }

        const text = element.textContent.toLowerCase().trim();

        // Ê†πÊìöË®≠ÂÆöÊ™¢Êü•ÊØèÂÄãÊ®°Âºè
        const patterns = [
          { pattern: 'accept all', enabled: this.config.enableAcceptAll },
          { pattern: 'accept', enabled: this.config.enableAccept },
          { pattern: 'run command', enabled: this.config.enableRunCommand },
          { pattern: 'run', enabled: this.config.enableRun },
          { pattern: 'apply', enabled: this.config.enableApply },
          { pattern: 'execute', enabled: this.config.enableExecute },
          { pattern: 'resume', enabled: this.config.enableResume },
        ];

        // Ê™¢Êü•ÊñáÂ≠óÊòØÂê¶ÂåπÈÖç‰ªª‰ΩïÂ∑≤ÂïüÁî®ÁöÑÊ®°Âºè
        const matchesEnabledPattern = patterns.some(
          ({ pattern, enabled }) => enabled && text.includes(pattern)
        );

        if (!matchesEnabledPattern) return false;

        const isVisible = this.isElementVisible(element);
        const isClickable = this.isElementClickable(element);

        return isVisible && isClickable;
      }

      // Ê™¢Êü•ÂÖÉÁ¥†ÊòØÂê¶ÂèØË¶ã
      isElementVisible(element) {
        const style = window.getComputedStyle(element);
        const rect = element.getBoundingClientRect();

        return (
          style.display !== 'none' &&
          style.visibility !== 'hidden' &&
          parseFloat(style.opacity) > 0.1 &&
          rect.width > 0 &&
          rect.height > 0
        );
      }

      // Ê™¢Êü•ÂÖÉÁ¥†ÊòØÂê¶ÂèØÈªûÊìä
      isElementClickable(element) {
        const style = window.getComputedStyle(element);
        return (
          style.pointerEvents !== 'none' && !element.disabled && !element.hasAttribute('disabled')
        );
      }

      // ‰ΩøÁî®Â§öÁ®ÆÁ≠ñÁï•ÈªûÊìäÂÖÉÁ¥†
      clickElement(element) {
        try {
          // Á¢∫ÂÆöÊåâÈàïÈ°ûÂûã‰ª•‰æøÊõ¥Â•ΩÂú∞ËøΩËπ§
          const buttonText = element.textContent.trim().toLowerCase();
          const isResumeLink = this.isResumeLink(element);

          if (this.debugMode) {
            this.log(`=== Èô§ÈåØÔºöÂëºÂè´ clickElement ===`);
            this.log(`ÊåâÈàïÊñáÂ≠óÔºö "${buttonText}"`);
            this.log(`ÊòØÂê¶ÁÇ∫ÁπºÁ∫åÂ∞çË©±ÈÄ£ÁµêÔºö ${isResumeLink}`);
            this.log(`ÂÖÉÁ¥† classÔºö ${element.className}`);
            this.log(`ÂÖÉÁ¥†Ê®ôÁ±§Ôºö ${element.tagName}`);
          }

          // Âú®ÈªûÊìäÂâçÊèêÂèñÊ™îÊ°àË≥áË®ä (ÂÉÖÈÅ©Áî®ÊñºÈùû "ÁπºÁ∫åÂ∞çË©±" ÊåâÈàï)
          let fileInfo = null;
          if (!isResumeLink) {
            fileInfo = this.extractFileInfo(element);
            if (this.debugMode) {
              this.log(`Èô§ÈåØÔºöÊ™îÊ°àË≥áË®äÊèêÂèñÁµêÊûúÔºö${fileInfo ? JSON.stringify(fileInfo) : 'null'}`);
            }
          }

          const rect = element.getBoundingClientRect();
          const x = rect.left + rect.width / 2;
          const y = rect.top + rect.height / 2;

          if (this.debugMode) {
            this.log(`Èô§ÈåØÔºöÂÖÉÁ¥†‰ΩçÁΩÆÔºöx=${x}, y=${y}`);
          }

          // Á≠ñÁï• 1ÔºöÁõ¥Êé•ÈªûÊìä
          element.click();

          // Á≠ñÁï• 2ÔºöÊªëÈº†‰∫ã‰ª∂
          const mouseEvent = new MouseEvent('click', {
            bubbles: true,
            cancelable: true,
            view: window,
            clientX: x,
            clientY: y,
          });
          element.dispatchEvent(mouseEvent);

          // Á≠ñÁï• 3ÔºöËÅöÁÑ¶Âíå Enter Èçµ (ÈÅ©Áî®ÊñºÊåâÈàïÂíå‰∫íÂãïÂÖÉÁ¥†)
          if (element.focus) element.focus();
          const enterEvent = new KeyboardEvent('keydown', {
            key: 'Enter',
            code: 'Enter',
            keyCode: 13,
            bubbles: true,
          });
          element.dispatchEvent(enterEvent);

          // ËôïÁêÜ‰∏çÂêåÊåâÈàïÈ°ûÂûã‰ª•ÈÄ≤Ë°åÂàÜÊûê
          if (isResumeLink) {
            // Â∞çÊñº "ÁπºÁ∫åÂ∞çË©±" ÈÄ£ÁµêÔºåÂè™ËøΩËπ§Êìç‰Ωú
            const timeSaved = this.calculateTimeSaved('resume-conversation');
            this.logToPanel(
              `üîÑ ÈªûÊìä‰∫ÜÁπºÁ∫åÂ∞çË©± [ÁØÄÁúÅ ${this.formatTimeDuration(timeSaved)}]`,
              'info'
            );
            this.log(`ÈªûÊìä‰∫ÜÁπºÁ∫åÂ∞çË©± - ÁØÄÁúÅÊôÇÈñìÔºö${this.formatTimeDuration(timeSaved)}`);

            // ËøΩËπ§ÊåâÈàïÈ°ûÂûãË®àÊï∏
            if (!this.analytics.buttonTypeCounts) {
              this.analytics.buttonTypeCounts = {};
            }
            this.analytics.buttonTypeCounts['ÁπºÁ∫åÂ∞çË©±'] =
              (this.analytics.buttonTypeCounts['ÁπºÁ∫åÂ∞çË©±'] || 0) + 1;

            // Êõ¥Êñ∞Á∏ΩË®à
            this.analytics.totalAccepts++;
            this.roiTracking.totalTimeSaved += timeSaved;

            // ÂÑ≤Â≠òÂà∞ÂÑ≤Â≠òÁ©∫Èñì
            this.saveToStorage();
          } else if (fileInfo) {
            // ËøΩËπ§Â∏∏Ë¶èÊåâÈàïÁöÑÊ™îÊ°àÂàÜÊûê
            this.trackFileAcceptance(fileInfo, buttonText);
          } else {
            // Âç≥‰ΩøÊ≤íÊúâÊ™îÊ°àË≥áË®äÔºå‰ªçËøΩËπ§ÁØÄÁúÅÁöÑÊôÇÈñì
            const timeSaved = this.calculateTimeSaved(buttonText);
            this.logToPanel(
              `‚úì Â∑≤ÈªûÊìäÔºö${element.textContent.trim()} [ÁØÄÁúÅ ${this.formatTimeDuration(
                timeSaved
              )}]`,
              'info'
            );

            // ËøΩËπ§ÊåâÈàïÈ°ûÂûãË®àÊï∏
            const normalizedType = this.normalizeButtonType(buttonText);
            if (!this.analytics.buttonTypeCounts) {
              this.analytics.buttonTypeCounts = {};
            }
            this.analytics.buttonTypeCounts[normalizedType] =
              (this.analytics.buttonTypeCounts[normalizedType] || 0) + 1;

            // Êõ¥Êñ∞Á∏ΩË®à
            this.analytics.totalAccepts++;
            this.roiTracking.totalTimeSaved += timeSaved;

            // ÂÑ≤Â≠òÂà∞ÂÑ≤Â≠òÁ©∫Èñì
            this.saveToStorage();
          }

          // Êõ¥Êñ∞ UI
          this.updatePanelStatus();
          if (this.currentTab === 'analytics' || this.currentTab === 'roi') {
            this.updateAnalyticsContent();
          }
          this.updateMainFooter();

          return true;
        } catch (error) {
          this.logToPanel(`ÈªûÊìäÂ§±ÊïóÔºö${error.message}`, 'warning');
          if (this.debugMode) {
            this.log(`Èô§ÈåØÔºöÈªûÊìäÈåØË™§Â†ÜÁñäÔºö${error.stack}`);
          }
          return false;
        }
      }

      // ‰∏ªË¶ÅÂü∑Ë°å
      checkAndClick() {
        try {
          const buttons = this.findAcceptButtons();

          if (buttons.length === 0) {
            // ‰∏çË¶ÅÂõ†„ÄåÊú™ÊâæÂà∞ÊåâÈàï„ÄçËÄåÈ†ªÁπÅË®òÈåÑÊó•Ë™å
            return;
          }

          // ÈªûÊìäÊâæÂà∞ÁöÑÁ¨¨‰∏ÄÂÄãÊåâÈàï
          const button = buttons[0];
          const buttonText = button.textContent.trim().substring(0, 30);

          const success = this.clickElement(button);
          if (success) {
            this.totalClicks++;
            this.updatePanelStatus();
          }
        } catch (error) {
          this.log(`Âü∑Ë°åÊôÇÂá∫ÈåØÔºö${error.message}`);
        }
      }

      start() {
        if (this.isRunning) {
          this.logToPanel('Â∑≤Á∂ìÂú®Âü∑Ë°å‰∏≠', 'warning');
          return;
        }

        this.isRunning = true;
        this.totalClicks = 0;
        this.updatePanelStatus();

        // ÂàùÂßãÊ™¢Êü•
        this.checkAndClick();

        // Ë®≠ÂÆöÈñìÈöî
        this.monitorInterval = setInterval(() => {
          this.checkAndClick();
        }, this.interval);

        this.logToPanel(`Â∑≤ÈñãÂßã (ÈñìÈöî ${this.interval / 1000} Áßí)`, 'info');
      }

      stop() {
        if (!this.isRunning) {
          this.logToPanel('Êú™Âú®Âü∑Ë°å', 'warning');
          return;
        }

        clearInterval(this.monitorInterval);
        this.isRunning = false;
        this.updatePanelStatus();
        this.logToPanel(`Â∑≤ÂÅúÊ≠¢ (${this.totalClicks} Ê¨°ÈªûÊìä)`, 'info');
      }

      status() {
        return {
          isRunning: this.isRunning,
          interval: this.interval,
          totalClicks: this.totalClicks,
          config: this.config,
        };
      }

      // Ë®≠ÂÆöÊéßÂà∂ÊñπÊ≥ï
      enableOnly(buttonTypes) {
        // È¶ñÂÖàÂÅúÁî®ÊâÄÊúâ
        Object.keys(this.config).forEach(key => {
          this.config[key] = false;
        });

        // ÂïüÁî®ÊåáÂÆöÁöÑÈ°ûÂûã
        buttonTypes.forEach(type => {
          const configKey = `enable${type.charAt(0).toUpperCase() + type.slice(1)}`;
          if (this.config.hasOwnProperty(configKey)) {
            this.config[configKey] = true;
            this.log(`Â∑≤ÂïüÁî® ${type} ÊåâÈàï`);
          }
        });

        this.log(`Ë®≠ÂÆöÂ∑≤Êõ¥Êñ∞ÔºöÂÉÖÂïüÁî® ${buttonTypes.join(', ')} ÊåâÈàï`);
      }

      enableAll() {
        Object.keys(this.config).forEach(key => {
          this.config[key] = true;
        });
        this.log('Â∑≤ÂïüÁî®ÊâÄÊúâÊåâÈàïÈ°ûÂûã');
      }

      disableAll() {
        Object.keys(this.config).forEach(key => {
          this.config[key] = false;
        });
        this.log('Â∑≤ÂÅúÁî®ÊâÄÊúâÊåâÈàïÈ°ûÂûã');
      }

      toggle(buttonType) {
        const configKey = `enable${buttonType.charAt(0).toUpperCase() + buttonType.slice(1)}`;
        if (this.config.hasOwnProperty(configKey)) {
          this.config[configKey] = !this.config[configKey];
          this.log(`${buttonType} ÊåâÈàï ${this.config[configKey] ? 'Â∑≤ÂïüÁî®' : 'Â∑≤ÂÅúÁî®'}`);
        } else {
          this.log(`Êú™Áü•ÁöÑÊåâÈàïÈ°ûÂûãÔºö${buttonType}`);
        }
      }

      enable(buttonType) {
        const configKey = `enable${buttonType.charAt(0).toUpperCase() + buttonType.slice(1)}`;
        if (this.config.hasOwnProperty(configKey)) {
          this.config[configKey] = true;
          this.log(`${buttonType} ÊåâÈàïÂ∑≤ÂïüÁî®`);
        } else {
          this.log(`Êú™Áü•ÁöÑÊåâÈàïÈ°ûÂûãÔºö${buttonType}`);
        }
      }

      disable(buttonType) {
        const configKey = `enable${buttonType.charAt(0).toUpperCase() + buttonType.slice(1)}`;
        if (this.config.hasOwnProperty(configKey)) {
          this.config[configKey] = false;
          this.log(`${buttonType} ÊåâÈàïÂ∑≤ÂÅúÁî®`);
        } else {
          this.log(`Êú™Áü•ÁöÑÊåâÈàïÈ°ûÂûãÔºö${buttonType}`);
        }
      }

      // ÊâãÂãïÊêúÂ∞ã‰ª•ÈÄ≤Ë°åÈô§ÈåØ
      debugSearch() {
        this.log('=== Èô§ÈåØÊêúÂ∞ã ===');
        const inputBox = document.querySelector('div.full-input-box');
        if (!inputBox) {
          this.log('Êú™ÊâæÂà∞Ëº∏ÂÖ•Ê°Ü');
          return;
        }

        this.log('ÊâæÂà∞Ëº∏ÂÖ•Ê°ÜÔºåÊ≠£Âú®Ê™¢Êü•ÂÖÑÂºüÂÖÉÁ¥†...');

        let currentElement = inputBox.previousElementSibling;
        let siblingIndex = 1;

        while (currentElement && siblingIndex <= 10) {
          this.log(
            `ÂÖÑÂºüÂÖÉÁ¥† ${siblingIndex}: ${currentElement.tagName} ${currentElement.className}`
          );

          // Ê™¢Êü•‰ªª‰ΩïÊñáÂ≠óÂÖßÂÆπ
          const text = currentElement.textContent ? currentElement.textContent.trim() : '';
          if (text) {
            this.log(`  ÊñáÂ≠óÔºö "${text.substring(0, 100)}"`);

            // ÁâπÂà•Ê™¢Êü• run/accept Ê®°Âºè
            const patterns = ['accept', 'run', 'execute', 'apply'];
            const foundPatterns = patterns.filter(pattern => text.toLowerCase().includes(pattern));
            if (foundPatterns.length > 0) {
              this.log(`  >>> ÂåÖÂê´Ê®°ÂºèÔºö${foundPatterns.join(', ')}`);
            }
          }

          // Ê™¢Êü•Ê≠§ÂÖÑÂºüÂÖÉÁ¥†‰∏≠ÁöÑÊåâÈàï
          const buttons = this.findAcceptInElement(currentElement);
          if (buttons.length > 0) {
            this.log(`  ÊâæÂà∞ ${buttons.length} ÂÄãÂèØÈªûÊìäÊåâÈàïÔºÅ`);
            buttons.forEach((btn, i) => {
              this.log(`    ÊåâÈàï ${i + 1}: "${btn.textContent.trim().substring(0, 50)}"`);
            });
          }

          currentElement = currentElement.previousElementSibling;
          siblingIndex++;
        }

        this.log('=== Èô§ÈåØÁµêÊùü ===');
      }

      // Âú®Ë®äÊÅØÊ∞£Ê≥°‰∏≠Â∞ãÊâæ "ÁπºÁ∫åÂ∞çË©±" ÈÄ£Áµê
      findResumeLinks() {
        const resumeLinks = [];

        // Âú® markdown ÂÖßÂÆπ‰∏≠Â∞ãÊâæ "ÁπºÁ∫åÂ∞çË©±" ÈÄ£Áµê
        const resumeSelectors = [
          '.markdown-link[data-link="command:composer.resumeCurrentChat"]',
          '.markdown-link[data-link*="resume"]',
          'span.markdown-link[data-link="command:composer.resumeCurrentChat"]',
        ];

        for (const selector of resumeSelectors) {
          const links = document.querySelectorAll(selector);
          for (const link of links) {
            if (this.isResumeLink(link)) {
              resumeLinks.push(link);
            }
          }
        }

        return resumeLinks;
      }

      // Ê™¢Êü•ÂÖÉÁ¥†ÊòØÂê¶ÁÇ∫ "ÁπºÁ∫åÂ∞çË©±" ÈÄ£Áµê
      isResumeLink(element) {
        if (!element) return false;

        // Ê™¢Êü• "ÁπºÁ∫åÂ∞çË©±" ÁöÑÁâπÂÆöÂ±¨ÊÄßÂíåÊñáÂ≠ó
        const hasResumeCommand =
          element.getAttribute('data-link') === 'command:composer.resumeCurrentChat';
        const hasResumeText =
          element.textContent && element.textContent.toLowerCase().includes('resume');
        const isMarkdownLink = element.classList.contains('markdown-link');

        if (!hasResumeCommand && !hasResumeText) return false;

        const isVisible = this.isElementVisible(element);
        const isClickable = this.isElementClickable(element);

        return isVisible && isClickable;
      }

      // Diff ÂçÄÂ°äÂÅµÊ∏¨ËàáÂàÜÊûê
      findDiffBlocks() {
        const diffBlocks = [];

        // Âú®Â∞çË©±‰∏≠Â∞ãÊâæ composer diff ÂçÄÂ°ä
        const diffSelectors = [
          'div.composer-diff-block',
          'div.composer-code-block-container',
          'div.composer-tool-former-message',
        ];

        for (const selector of diffSelectors) {
          const blocks = document.querySelectorAll(selector);
          for (const block of blocks) {
            const diffInfo = this.analyzeDiffBlock(block);
            if (diffInfo) {
              diffBlocks.push(diffInfo);
            }
          }
        }

        return diffBlocks;
      }

      // ÂàÜÊûêÂñÆ‰∏Ä diff ÂçÄÂ°äÁöÑÊ™îÊ°àË≥áË®ä
      analyzeDiffBlock(block) {
        try {
          if (!block) return null;

          const diffInfo = {
            blockElement: block,
            timestamp: new Date(),
            files: [],
            changeType: 'Êú™Áü•', // 'unknown'
          };

          // Â∞ãÊâæÊ™îÊ°àÊ®ôÈ†≠Ë≥áË®ä
          const fileHeader = block.querySelector('.composer-code-block-header');
          if (fileHeader) {
            const fileInfo = this.extractFileInfoFromHeader(fileHeader);
            if (fileInfo) {
              diffInfo.files.push(fileInfo);
            }
          }

          // Âú®Ê™îÂêç span ‰∏≠Â∞ãÊâæÊ™îÂêç
          const filenameSpan = block.querySelector('.composer-code-block-filename span');
          if (filenameSpan && !diffInfo.files.length) {
            const filename = filenameSpan.textContent.trim();
            if (filename) {
              diffInfo.files.push({
                name: filename,
                path: filename,
                extension: this.getFileExtension(filename),
              });
            }
          }

          // Ê™¢Êü•ËÆäÊõ¥ÊåáÁ§∫Âô® (+/- Êï∏Â≠ó)
          const statusSpan = block.querySelector(
            '.composer-code-block-status span[style*="color"]'
          );
          if (statusSpan) {
            const statusText = statusSpan.textContent.trim();
            if (statusText.includes('+')) {
              diffInfo.changeType = 'Â¢ûÂä†'; // 'addition'
              diffInfo.linesAdded = this.extractNumber(statusText);
            } else if (statusText.includes('-')) {
              diffInfo.changeType = 'Âà™Èô§'; // 'deletion'
              diffInfo.linesDeleted = this.extractNumber(statusText);
            }
          }

          // Â∞ãÊâæÂ¢ûÂä†ÂíåÂà™Èô§
          const allStatusSpans = block.querySelectorAll(
            '.composer-code-block-status span[style*="color"]'
          );
          let hasAdditions = false,
            hasDeletions = false;

          allStatusSpans.forEach(span => {
            const text = span.textContent.trim();
            if (text.includes('+')) {
              hasAdditions = true;
              diffInfo.linesAdded = this.extractNumber(text);
            } else if (text.includes('-')) {
              hasDeletions = true;
              diffInfo.linesDeleted = this.extractNumber(text);
            }
          });

          if (hasAdditions && hasDeletions) {
            diffInfo.changeType = '‰øÆÊîπ'; // 'modification'
          } else if (hasAdditions) {
            diffInfo.changeType = 'Â¢ûÂä†'; // 'addition'
          } else if (hasDeletions) {
            diffInfo.changeType = 'Âà™Èô§'; // 'deletion'
          }

          return diffInfo.files.length > 0 ? diffInfo : null;
        } catch (error) {
          this.log(`ÂàÜÊûê diff ÂçÄÂ°äÊôÇÂá∫ÈåØÔºö${error.message}`);
          return null;
        }
      }

      // ÂæûÁ®ãÂºèÁ¢ºÂçÄÂ°äÊ®ôÈ†≠ÊèêÂèñÊ™îÊ°àË≥áË®ä
      extractFileInfoFromHeader(header) {
        try {
          const fileInfo = header.querySelector('.composer-code-block-file-info');
          if (!fileInfo) return null;

          const filenameElement = fileInfo.querySelector('.composer-code-block-filename span');
          const filename = filenameElement ? filenameElement.textContent.trim() : null;

          if (!filename) return null;

          return {
            name: filename,
            path: filename,
            extension: this.getFileExtension(filename),
            hasIcon: !!fileInfo.querySelector('.composer-code-block-file-icon'),
          };
        } catch (error) {
          this.log(`ÂæûÊ®ôÈ†≠ÊèêÂèñÊ™îÊ°àË≥áË®äÊôÇÂá∫ÈåØÔºö${error.message}`);
          return null;
        }
      }

      // ÂæûÊ™îÂêçÁç≤ÂèñÂâØÊ™îÂêç
      getFileExtension(filename) {
        if (!filename || typeof filename !== 'string') return '';
        const lastDot = filename.lastIndexOf('.');
        return lastDot > 0 ? filename.substring(lastDot + 1).toLowerCase() : '';
      }

      // ÂæûÊñáÂ≠ó‰∏≠ÊèêÂèñÊï∏Â≠ó (‰æãÂ¶Ç, "+17" -> 17)
      extractNumber(text) {
        if (!text) return 0;
        const match = text.match(/[+-]?(\d+)/);
        return match ? parseInt(match[1], 10) : 0;
      }

      // Âú®Â∞çË©±‰∏≠Â∞ãÊâæÊúÄËøëÁöÑ diff ÂçÄÂ°ä
      findRecentDiffBlocks(maxAge = 30000) {
        // È†êË®≠ 30 Áßí
        const allDiffs = this.findDiffBlocks();
        const cutoffTime = Date.now() - maxAge;

        return allDiffs.filter(diff => diff.timestamp && diff.timestamp.getTime() > cutoffTime);
      }

      // Áç≤ÂèñÊ™îÊ°àËÆäÊõ¥ÁöÑÂ∞çË©±‰∏ä‰∏ãÊñá
      getConversationContext() {
        const conversationDiv = document.querySelector('div.conversations');
        if (!conversationDiv) {
          this.log('Êú™ÊâæÂà∞Â∞çË©±ÂÆπÂô®');
          return null;
        }

        const context = {
          conversationElement: conversationDiv,
          totalMessages: 0,
          recentDiffs: [],
          filesChanged: new Set(),
          lastActivity: null,
        };

        // Ë®àÁÆóË®äÊÅØÊ∞£Ê≥°Êï∏Èáè
        const messageBubbles = conversationDiv.querySelectorAll('[data-message-index]');
        context.totalMessages = messageBubbles.length;

        // Â∞ãÊâæÊúÄËøëÁöÑ diff ÂçÄÂ°ä
        const recentDiffs = this.findRecentDiffBlocks();
        context.recentDiffs = recentDiffs;

        // ÂæûÊúÄËøëÁöÑ diff ‰∏≠ÊèêÂèñÂîØ‰∏ÄÁöÑÊ™îÊ°à
        recentDiffs.forEach(diff => {
          diff.files.forEach(file => {
            context.filesChanged.add(file.name);
          });
        });

        // Â∞á Set ËΩâÊèõÁÇ∫ Array ‰ª•‰æøËôïÁêÜ
        context.filesChanged = Array.from(context.filesChanged);

        // Â∞ãÊâæÊúÄÂæåÊ¥ªÂãïÁöÑÊôÇÈñìÊà≥
        if (messageBubbles.length > 0) {
          const lastBubble = messageBubbles[messageBubbles.length - 1];
          context.lastActivity = new Date(); // ‰ΩøÁî®ÁõÆÂâçÊôÇÈñì‰ΩúÁÇ∫Ëøë‰ººÂÄº
        }

        return context;
      }

      // Â∏∂ÊúâÂ∞çË©±‰∏ä‰∏ãÊñáÁöÑÂ¢ûÂº∑Êó•Ë™åË®òÈåÑ
      logConversationActivity() {
        const context = this.getConversationContext();
        if (!context) return;

        this.log('=== Â∞çË©±Ê¥ªÂãï ===');
        this.log(`Á∏ΩË®äÊÅØÊï∏Ôºö${context.totalMessages}`);
        this.log(`ÊúÄËøëÁöÑ diff Êï∏Ôºö${context.recentDiffs.length}`);
        this.log(`Â∑≤ËÆäÊõ¥Ê™îÊ°àÊï∏Ôºö${context.filesChanged.length}`);

        if (context.filesChanged.length > 0) {
          this.log(`Â∑≤ËÆäÊõ¥Ê™îÊ°àÔºö${context.filesChanged.join(', ')}`);
        }

        context.recentDiffs.forEach((diff, index) => {
          this.log(
            `Diff ${index + 1}Ôºö${diff.changeType} - ${diff.files.map(f => f.name).join(', ')}`
          );
          if (diff.linesAdded) this.log(`  +${diff.linesAdded} Ë°åÂ¢ûÂä†`);
          if (diff.linesDeleted) this.log(`  -${diff.linesDeleted} Ë°åÂà™Èô§`);
        });

        this.log('=== Â∞çË©±Ê¥ªÂãïÁµêÊùü ===');
      }
    }

    globalThis.autoAcceptAndAnalytics = autoAcceptAndAnalytics;
  }

  // ÂàùÂßãÂåñ
  if (!globalThis.simpleAccept) {
    globalThis.simpleAccept = new globalThis.autoAcceptAndAnalytics(2000);

    // ÂÖ¨ÈñãÊéßÂà∂È†Ö
    globalThis.startAccept = () => globalThis.simpleAccept.start();
    globalThis.stopAccept = () => globalThis.simpleAccept.stop();
    globalThis.acceptStatus = () => globalThis.simpleAccept.status();
    globalThis.debugAccept = () => globalThis.simpleAccept.debugSearch();

    // Âº∑Âà∂Êó•Ë™åÊ∏¨Ë©¶ÂáΩÊï∏
    globalThis.testLogs = () => {
      console.log('Ê∏¨Ë©¶Êó•Ë™å 1 - console.log');
      console.info('Ê∏¨Ë©¶Êó•Ë™å 2 - console.info');
      console.warn('Ê∏¨Ë©¶Êó•Ë™å 3 - console.warn');
      console.error('Ê∏¨Ë©¶Êó•Ë™å 4 - console.error');
      alert('Ê∏¨Ë©¶ÔºöÊéßÂà∂Âè∞Êó•Ë™åÊ∏¨Ë©¶ÂÆåÊàê„ÄÇË´ãÊ™¢Êü•‰∏äÊñπÁöÑÊéßÂà∂Âè∞„ÄÇ');
      return 'Êó•Ë™åÊ∏¨Ë©¶ÂÆåÊàê';
    };

    // Ë®≠ÂÆöÊéßÂà∂È†Ö
    globalThis.enableOnly = types => globalThis.simpleAccept.enableOnly(types);
    globalThis.enableAll = () => globalThis.simpleAccept.enableAll();
    globalThis.disableAll = () => globalThis.simpleAccept.disableAll();
    globalThis.toggleButton = type => globalThis.simpleAccept.toggle(type);
    globalThis.enableButton = type => globalThis.simpleAccept.enable(type);
    globalThis.disableButton = type => globalThis.simpleAccept.disable(type);

    // ÂàÜÊûêÊéßÂà∂È†Ö
    globalThis.exportAnalytics = () => globalThis.simpleAccept.exportAnalytics();
    globalThis.clearAnalytics = () => globalThis.simpleAccept.clearAnalytics();
    globalThis.clearStorage = () => globalThis.simpleAccept.clearStorage();
    globalThis.validateData = () => globalThis.simpleAccept.validateData();
    globalThis.toggleDebug = () => globalThis.simpleAccept.toggleDebug();
    globalThis.calibrateWorkflow = (manualSeconds, autoMs) =>
      globalThis.simpleAccept.calibrateWorkflowTimes(manualSeconds, autoMs);
    globalThis.showAnalytics = () => {
      globalThis.simpleAccept.switchTab('analytics');
      console.log('ÊéßÂà∂Èù¢Êùø‰∏≠ÁöÑÂàÜÊûêÊ®ôÁ±§È†ÅÂ∑≤ÊâìÈñã');
    };

    // Â∞çË©±ÂàÜÊûêÊéßÂà∂È†Ö
    globalThis.findDiffs = () => globalThis.simpleAccept.findDiffBlocks();
    globalThis.getContext = () => globalThis.simpleAccept.getConversationContext();
    globalThis.logActivity = () => globalThis.simpleAccept.logConversationActivity();
    globalThis.recentDiffs = maxAge => globalThis.simpleAccept.findRecentDiffBlocks(maxAge);

    // Èô§ÈåØÊéßÂà∂È†Ö
    globalThis.enableDebug = () => {
      globalThis.simpleAccept.debugMode = true;
      console.log('Èô§ÈåØÊ®°ÂºèÂ∑≤ÂïüÁî® - Ê™îÊ°àÊèêÂèñÊó•Ë™åÂ∑≤ÂïüÂãï');
    };
    globalThis.disableDebug = () => {
      globalThis.simpleAccept.debugMode = false;
      console.log('Èô§ÈåØÊ®°ÂºèÂ∑≤ÂÅúÁî®');
    };

    // Âº∑Âà∂È°ØÁ§∫ÂïüÂãïË®äÊÅØ
    const startupMsg = '[autoAcceptAndAnalytics] ËÖ≥Êú¨Â∑≤ËºâÂÖ•‰∏¶ÂïüÂãïÔºÅ';
    console.log(startupMsg);
    console.info(startupMsg);
    console.warn(startupMsg);

    // ÂêåÊôÇÂª∫Á´ãË¶ñË¶∫ÈÄöÁü•
    try {
      const notification = document.createElement('div');
      notification.textContent =
        '‚úÖ Ëá™ÂãïÊé•ÂèóÊéßÂà∂Èù¢ÊùøÂ∑≤Â∞±Á∑íÔºÅÁèæÂ∑≤Âä†ÂÖ•Ê™îÊ°àÂàÜÊûêÂäüËÉΩ - Ë´ãÈªûÊìä„ÄåÂàÜÊûê„ÄçÊ®ôÁ±§È†ÅÔºÅ';
      notification.style.cssText =
        'position:fixed;top:10px;left:50%;transform:translateX(-50%);background:#4CAF50;color:white;padding:10px 20px;border-radius:5px;z-index:99999;font-weight:bold;max-width:400px;text-align:center;';
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 4000);
    } catch (e) {
      // ÂøΩÁï•
    }

    console.log('ÂëΩ‰ª§: startAccept(), stopAccept(), acceptStatus(), debugAccept()');
    console.log(
      'ÂàÜÊûê: showAnalytics(), exportAnalytics(), clearAnalytics(), clearStorage(), validateData()'
    );
    console.log('Èô§ÈåØ: toggleDebug(), enableDebug(), disableDebug() - ÊéßÂà∂Èô§ÈåØÊó•Ë™å');
    console.log('Ê†°Ê∫ñ: calibrateWorkflow(manualSeconds, autoMs) - Ë™øÊï¥Â∑•‰ΩúÊµÅÁ®ãË®àÊôÇ');
    console.log('Ë®≠ÂÆö: enableOnly([types]), enableAll(), disableAll(), toggleButton(type)');
    console.log('Â∞çË©±: findDiffs(), getContext(), logActivity(), recentDiffs(maxAge)');
    console.log('È°ûÂûã: "acceptAll", "accept", "run", "runCommand", "apply", "execute", "resume"');
  }
})();
